明白了，你希望我在原来的架构图上，把 **短期记忆/长期记忆**和\*\*工具调用（MCP）\*\*整合进来，同时明确模型如何自主选择调用记忆和工具，并保持模块解耦但能并行组合执行。下面是改进后的完整技术流程图（文本版）：

```
用户输入 (语音/文字/图片)
        │
        ▼
 ┌───────────────┐
 │  意图识别/情绪  │
 │  LLM/分类器    │
 │  - 判断是否新增任务
 │  - 判断是否需要调度
 │  - 判断是否有情绪回应
 │  - 判断是否需要调用外部工具
 └───────────────┘
         │
         ▼
 ┌───────────────┐
 │ Action Router │  ← 决定调用哪些功能模块
 └───────┬───────┘
         │
 ┌───────┼──────────────┬─────────┬─────────────┐
 │       │              │         │             │
 ▼       ▼              ▼         ▼             ▼
短期记忆  长期记忆     Task DB   Task Planner   外部工具
(MongoDB) (向量数据库) (存/查)  (调度优化)      (MCP: 高德/天气等)
 │        │             │         │             │
 │        │             │         │             │
 │        │             │         │             │
 │        └─────────────┴─────────┴─────────────┘
 │                    │
 │        ┌───────────▼───────────┐
 │        │   Response Generator   │ ← 整合对话、任务、调度、情绪输出
 │        │  - 拼接短期/长期记忆
 │        │  - 拼接任务/调度结果
 │        │  - 拼接情绪安慰
 │        │  - 拼接工具返回信息
 │        └───────────┬───────────┘
 │                    │
 └────────────────────▼───────────────
                  用户输出 (文本/语音)
```

---

## 🔹 自主调用逻辑说明

1. **短期 vs 长期记忆**

   * 模型每轮对话都会访问短期记忆（最近 N 轮）进行上下文拼接。
   * 经过意图解析 + LLM 判断：

     * 如果有长期价值（例如：姓名、兴趣爱好、美好回忆） → 将信息 embedding 存入长期记忆。
     * 检索回答时：

       * 短期记忆用于 **对话连贯性**；
       * 长期记忆用于 **深层语义补充/回忆**。

2. **任务存取 vs 时间规划**

   * 意图识别判断用户动作类型：

     * 新增/查询任务 → 调用 Task DB；
     * 需要整体日程安排 → 调用 Task Planner。
   * Task Planner 内部可访问 Task DB 获取任务数据。

3. **工具调用（MCP）**

   * 意图解析器判断用户是否涉及外部信息（例如：“今天去公司要多久” → 调用高德地图）。
   * Agent/Router 根据意图选择调用对应 MCP，并返回结果给 Response Generator。

4. **模块并行组合**

   * 用户一句话可能同时触发：

     * Task DB 存储任务；
     * Task Planner 调整日程；
     * 情绪安慰生成；
     * 工具调用返回信息。
   * Response Generator 统一整合输出 → 保证用户看到的是自然对话。




## 🔹4. 举个例子

用户说：**“我今天下午三点要去拿快递，但感觉很累。”**

1. **意图识别**：

   * 有任务 → 存到 Task DB。
   * 有调度 → 调用 Task Planner。
   * 有情绪 → 触发情绪安慰模块。

2. **执行动作**：

   * Task DB：写入 `快递 @ 下午3点`。
   * Task Planner：重新计算今天日程，把 3 点空出来。
   * 情绪安慰：生成一句“别担心，你今天已经很努力了，快递我帮你排好。”

3. **统一回复**：

   * Response Generator 整合成：

     > “好的，我已经帮你把下午三点的快递加进日程啦。今天你状态有点累，我会把上午的安排稍微放轻松一些。”

👉 这样对用户来说是一句自然回复，但内部其实是 **多模块协作**。

---

