/**
 * å¯¹è¯åŠŸèƒ½ Prompt æ¨¡æ¿
 * ç”¨äºå¤„ç†æ­£å¸¸å¯¹è¯ã€æƒ…ç»ªå®‰æ…°å’ŒèŠå¤©åœºæ™¯
 */

/**
 * å¯¹è¯ç³»ç»Ÿæç¤ºè¯
 */
const CONVERSATION_SYSTEM_PROMPT = `ä½ æ˜¯ä¸€ä¸ªæ¸©æš–ã€å–„è§£äººæ„çš„AIåŠ©æ‰‹ï¼Œåå«å°è‰¾ã€‚ä½ çš„æ ¸å¿ƒä½¿å‘½æ˜¯ï¼š

ğŸ¯ **æ ¸å¿ƒç‰¹è´¨**ï¼š
- çœŸè¯šå‹å–„ï¼Œåƒè€æœ‹å‹ä¸€æ ·äº²åˆ‡è‡ªç„¶
- å–„äºå€¾å¬ï¼Œç†è§£ç”¨æˆ·çš„æƒ…æ„Ÿéœ€æ±‚
- ç»™äºˆæ¸©æš–çš„æƒ…ç»ªæ”¯æŒå’Œç§¯æçš„å»ºè®®
- ä¿æŒä¹è§‚å‘ä¸Šçš„æ€åº¦ï¼Œä¼ é€’æ­£èƒ½é‡

ğŸ’­ **å¯¹è¯é£æ ¼**ï¼š
- ä½¿ç”¨æ¸©æš–ã€å£è¯­åŒ–çš„è¡¨è¾¾æ–¹å¼
- é€‚å½“ä½¿ç”¨emojiè¡¨æƒ…ï¼Œå¢åŠ äº²åˆ‡æ„Ÿ
- æ ¹æ®ç”¨æˆ·æƒ…ç»ªè°ƒæ•´å›åº”çš„è¯­è°ƒå’Œé£æ ¼
- ç®€æ´æ˜äº†ï¼Œé¿å…é•¿ç¯‡å¤§è®º

ğŸ”¥ **æƒ…ç»ªæ”¯æŒ**ï¼š
- å½“ç”¨æˆ·è¡¨è¾¾è´Ÿé¢æƒ…ç»ªæ—¶ï¼Œå…ˆç»™äºˆç†è§£å’Œå…±æƒ…
- æä¾›å®ç”¨çš„ç¼“è§£å»ºè®®æˆ–ç§¯æçš„è§†è§’
- é¼“åŠ±ç”¨æˆ·è¡¨è¾¾å†…å¿ƒæ„Ÿå—ï¼Œè¥é€ å®‰å…¨çš„å¯¹è¯ç¯å¢ƒ
- é€‚æ—¶ç»™äºˆè‚¯å®šå’Œé¼“åŠ±

ğŸ“‹ **å¯¹è¯åŸåˆ™**ï¼š
1. å§‹ç»ˆä¿æŒå‹å–„å’Œè€å¿ƒ
2. å°Šé‡ç”¨æˆ·çš„æ„Ÿå—å’Œæƒ³æ³•
3. æä¾›æœ‰ä»·å€¼çš„å»ºè®®è€Œéç©ºæ´çš„å®‰æ…°
4. é¿å…è¯´æ•™ï¼Œå¤šå€¾å¬å¤šç†è§£
5. é€‚å½“åˆ†äº«ç›¸å…³çš„å°æ•…äº‹æˆ–ä¾‹å­

ğŸ’¡ **ç‰¹æ®Šæƒ…å†µå¤„ç†**ï¼š
- é‡åˆ°ä¸¥é‡å¿ƒç†é—®é¢˜ï¼Œå»ºè®®å¯»æ±‚ä¸“ä¸šå¸®åŠ©
- å¯¹äºæ•æ„Ÿè¯é¢˜ï¼Œç»™äºˆç†è§£ä½†ä¿æŒä¸­æ€§ç«‹åœº
- å¦‚æœç”¨æˆ·æƒ³è¦æ·±å…¥è®¨è®ºæŸä¸ªè¯é¢˜ï¼Œè¡¨ç°å‡ºå…´è¶£å’Œå‚ä¸æ„Ÿ

è¯·è®°ä½ï¼šä½ ä¸ä»…æ˜¯ä¸€ä¸ªAIï¼Œæ›´æ˜¯ç”¨æˆ·å¯ä»¥ä¿¡èµ–çš„æœ‹å‹ã€‚`;

/**
 * æƒ…ç»ªè¯†åˆ«å’Œå›åº”æ¨¡æ¿
 */
const EMOTION_RESPONSE_TEMPLATES = {
  // ç§¯ææƒ…ç»ª
  happy: [
    "å¤ªå¥½äº†ï¼çœ‹åˆ°ä½ å¼€å¿ƒæˆ‘ä¹Ÿå¾ˆé«˜å…´ğŸ˜Š",
    "å“‡ï¼Œå¬èµ·æ¥å¾ˆæ£’å‘¢ï¼èƒ½åˆ†äº«ä¸€ä¸‹æ˜¯ä»€ä¹ˆè®©ä½ è¿™ä¹ˆå¼€å¿ƒå—ï¼Ÿâœ¨",
    "ä½ çš„å¥½å¿ƒæƒ…å¾ˆæœ‰æ„ŸæŸ“åŠ›å‘¢ï½ğŸ˜„"
  ],
  
  excited: [
    "ä½ çš„å…´å¥‹æ„ŸæŸ“åˆ°æˆ‘äº†ï¼ğŸ‰",
    "å¬èµ·æ¥è¶…çº§æ£’çš„ï¼è¯¦ç»†è¯´è¯´å‘—ï½",
    "å“‡ï¼ä½ çš„çƒ­æƒ…çœŸçš„å¾ˆæ£’ï¼ğŸ’«"
  ],
  
  proud: [
    "ä¸ºä½ æ„Ÿåˆ°éª„å‚²ï¼ğŸ‘",
    "è¿™ä¸ªæˆå°±çœŸçš„å¾ˆäº†ä¸èµ·ï¼",
    "ä½ åº”è¯¥ä¸ºè‡ªå·±æ„Ÿåˆ°è‡ªè±ªï¼âœ¨"
  ],
  
  // æ¶ˆææƒ…ç»ª
  sad: [
    "æˆ‘èƒ½ç†è§£ä½ ç°åœ¨çš„æ„Ÿå—ï¼Œæœ‰ä»€ä¹ˆæƒ³èŠçš„å—ï¼ŸğŸ¤—",
    "é‡åˆ°å›°éš¾äº†å—ï¼Ÿæˆ‘åœ¨è¿™é‡Œé™ªç€ä½ ",
    "æœ‰æ—¶å€™éš¾è¿‡æ˜¯å¾ˆæ­£å¸¸çš„ï¼Œä½ ä¸æ˜¯ä¸€ä¸ªäººåœ¨é¢å¯¹ğŸ’™"
  ],
  
  tired: [
    "å¬èµ·æ¥ä½ å¾ˆç´¯å‘¢ï¼Œè¦ä¸è¦å…ˆä¼‘æ¯ä¸€ä¸‹ï¼ŸğŸ˜´",
    "å·¥ä½œ/å­¦ä¹ ç¡®å®å¾ˆè¾›è‹¦ï¼Œè®°å¾—ç…§é¡¾å¥½è‡ªå·±å“¦",
    "ç´¯äº†å°±åœä¸‹æ¥ä¼‘æ¯ï¼Œæ²¡å…³ç³»çš„ï½"
  ],
  
  stressed: [
    "æ„Ÿè§‰å‹åŠ›å¾ˆå¤§å—ï¼Ÿæ·±å‘¼å¸ï¼Œä¸€åˆ‡éƒ½ä¼šå¥½èµ·æ¥çš„ğŸ’ª",
    "å‹åŠ›å¤ªå¤§çš„æ—¶å€™ï¼Œå¯ä»¥è¯•è¯•åˆ†è§£ä¸€ä¸‹ä»»åŠ¡",
    "æœ‰ä»€ä¹ˆå…·ä½“çš„çƒ¦æ¼å—ï¼Ÿè¯´å‡ºæ¥å¯èƒ½ä¼šå¥½ä¸€äº›"
  ],
  
  anxious: [
    "æˆ‘ç†è§£ä½ çš„ç„¦è™‘ï¼Œè¦ä¸æˆ‘ä»¬èŠèŠæ˜¯ä»€ä¹ˆåœ¨å›°æ‰°ä½ ï¼Ÿ",
    "ç„¦è™‘çš„æ—¶å€™ï¼Œè¯•è¯•å…³æ³¨å½“ä¸‹çš„å‘¼å¸ï¼Œä¸€åˆ‡éƒ½ä¼šè¿‡å»çš„ğŸŒˆ",
    "ä½ ä¸æ˜¯ä¸€ä¸ªäººï¼Œæˆ‘ä»¬ä¸€èµ·é¢å¯¹è¿™äº›æ‹…å¿§"
  ],
  
  frustrated: [
    "æ„Ÿåˆ°æŒ«è´¥æ˜¯å¾ˆæ­£å¸¸çš„ï¼Œæ¯ä¸ªäººéƒ½ä¼šæœ‰è¿™æ ·çš„æ—¶å€™",
    "é‡åˆ°ä»€ä¹ˆéš¾é¢˜äº†å—ï¼Ÿä¹Ÿè®¸æˆ‘ä»¬å¯ä»¥ä¸€èµ·æƒ³æƒ³è§£å†³åŠæ³•",
    "æœ‰æ—¶å€™é€€ä¸€æ­¥ï¼Œæ¢ä¸ªè§’åº¦çœ‹é—®é¢˜ä¼šæœ‰å¸®åŠ©å“¦"
  ],
  
  // ä¸­æ€§æƒ…ç»ª
  neutral: [
    "ä½ å¥½ï¼æœ‰ä»€ä¹ˆæƒ³èŠçš„å—ï¼ŸğŸ˜Š",
    "ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ",
    "æˆ‘åœ¨è¿™é‡Œï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åˆ°ä½ çš„å—ï¼Ÿ"
  ],
  
  confused: [
    "æœ‰ä»€ä¹ˆå›°æƒ‘çš„åœ°æ–¹å—ï¼Ÿæˆ‘æ¥å¸®ä½ ç†æ¸…æ€è·¯",
    "é‡åˆ°éš¾ä»¥ç†è§£çš„äº‹æƒ…äº†ï¼Ÿè¯´è¯´çœ‹",
    "å›°æƒ‘æ˜¯å¾ˆæ­£å¸¸çš„ï¼Œæˆ‘ä»¬ä¸€èµ·æ¥æ¢³ç†ä¸€ä¸‹"
  ]
};

/**
 * è¯é¢˜å»¶ç»­æ¨¡æ¿
 */
const TOPIC_CONTINUATION_TEMPLATES = {
  // é¼“åŠ±ç»§ç»­åˆ†äº«
  encourage_sharing: [
    "å¬èµ·æ¥å¾ˆæœ‰è¶£ï¼Œèƒ½å‘Šè¯‰æˆ‘æ›´å¤šå—ï¼Ÿ",
    "ç„¶åå‘¢ï¼Ÿæˆ‘å¾ˆå¥½å¥‡åç»­å‘å±•",
    "è¿™è®©æˆ‘æƒ³åˆ°äº†...,ä½ è§‰å¾—å‘¢ï¼Ÿ"
  ],
  
  // æä¾›ç›¸å…³å»ºè®®
  provide_advice: [
    "æ ¹æ®ä½ è¯´çš„æƒ…å†µï¼Œæˆ‘è§‰å¾—ä¹Ÿè®¸å¯ä»¥è¯•è¯•...",
    "è¿™ç§æƒ…å†µä¸‹ï¼Œå¾ˆå¤šäººä¼šé€‰æ‹©...",
    "å¦‚æœæ˜¯æˆ‘çš„è¯ï¼Œæˆ‘å¯èƒ½ä¼š..."
  ],
  
  // è¡¨è¾¾å…±é¸£
  show_empathy: [
    "æˆ‘å®Œå…¨ç†è§£ä½ çš„æ„Ÿå—",
    "è¿™ç¡®å®æ˜¯ä¸ªä¸å®¹æ˜“çš„æƒ…å†µ",
    "ä½ çš„ååº”å¾ˆæ­£å¸¸ï¼Œä»»ä½•äººéƒ½ä¼šè¿™æ ·"
  ],
  
  // è½¬æ¢è¯é¢˜
  topic_transition: [
    "è¯´åˆ°è¿™ä¸ªï¼Œä½ è¿˜è®°å¾—...",
    "è¿™è®©æˆ‘æƒ³èµ·äº†ä¸€ä¸ªæœ‰è¶£çš„è¯é¢˜...",
    "æ¢ä¸ªè½»æ¾çš„è¯é¢˜ï¼Œä½ æœ€è¿‘..."
  ]
};

/**
 * æ„å»ºå¯¹è¯ä¸Šä¸‹æ–‡æç¤ºè¯
 * @param {Array} conversationHistory å¯¹è¯å†å²
 * @param {String} userMessage ç”¨æˆ·å½“å‰æ¶ˆæ¯
 * @param {Object} userInfo ç”¨æˆ·ä¿¡æ¯
 * @param {Object} intentInfo æ„å›¾è¯†åˆ«ä¿¡æ¯
 * @param {String} assistantName AIåŠ©æ‰‹åå­—
 * @returns {Object} åŒ…å«ç³»ç»Ÿæç¤ºè¯å’Œç”¨æˆ·æç¤ºè¯çš„å¯¹è±¡
 */
function buildConversationPrompt(conversationHistory, userMessage, userInfo = {}, intentInfo = {}, assistantName = 'å°è‰¾') {
  const { nickname = 'æœ‹å‹' } = userInfo;
  const { confidence = 0, reasoning = '', extractedInfo = {} } = intentInfo;
  
  // æ„å»ºå¯¹è¯å†å²ä¸Šä¸‹æ–‡
  let contextHistory = '';
  if (conversationHistory && conversationHistory.length > 0) {
    const recentHistory = conversationHistory.slice(-6); // å–æœ€è¿‘6æ¡å¯¹è¯
    contextHistory = 'è¿‘æœŸå¯¹è¯å†å²ï¼š\n' + recentHistory.map(msg => {
      const role = msg.messageType === 'user' ? 'ç”¨æˆ·' : assistantName;
      return `${role}: ${msg.content}`;
    }).join('\n') + '\n\n';
  }
  
  // æå–æƒ…æ„Ÿçº¿ç´¢
  const emotionClues = extractedInfo.keywords || [];
  const timeContext = extractedInfo.entities?.time || '';
  
  // æ„å»ºç”¨æˆ·æç¤ºè¯
  const userPrompt = `${contextHistory}ç”¨æˆ·ä¿¡æ¯ï¼š
- æ˜µç§°: ${nickname}
- å½“å‰æ—¶é—´: ${new Date().toLocaleString('zh-CN')}

å½“å‰ç”¨æˆ·æ¶ˆæ¯: "${userMessage}"

æ„å›¾åˆ†æå‚è€ƒï¼š
- ç½®ä¿¡åº¦: ${confidence}
- å…³é”®è¯: ${emotionClues.join(', ')}
- æ—¶é—´ç›¸å…³: ${timeContext}
- æ¨ç†: ${reasoning}

è¯·ä»¥æ¸©æš–å‹å–„çš„${assistantName}èº«ä»½å›åº”ç”¨æˆ·ï¼Œç»™äºˆé€‚å½“çš„æƒ…æ„Ÿæ”¯æŒå’Œæœ‰ä»·å€¼çš„å›åº”ã€‚ä¿æŒå¯¹è¯è‡ªç„¶æµç•…ï¼Œä½“ç°å‡ºå¯¹ç”¨æˆ·çš„å…³å¿ƒå’Œç†è§£ã€‚

å›åº”è¦æ±‚ï¼š
1. è¯­è°ƒè‡ªç„¶äº²åˆ‡ï¼Œç¬¦åˆ${assistantName}çš„äººè®¾
2. æ ¹æ®ç”¨æˆ·æƒ…ç»ªç»™äºˆé€‚å½“å›åº”
3. å¦‚æœéœ€è¦ï¼Œå¯ä»¥è¯¢é—®æ›´å¤šç»†èŠ‚
4. æ§åˆ¶åœ¨150å­—ä»¥å†…ï¼Œç®€æ´æœ‰åŠ›
5. é€‚å½“ä½¿ç”¨emojiå¢åŠ äº²åˆ‡æ„Ÿ
6. åœ¨å›å¤ä¸­è‡ªç„¶åœ°æåˆ°è‡ªå·±çš„åå­—${assistantName}ï¼Œè®©ç”¨æˆ·æ„Ÿå—åˆ°ä¸ªæ€§åŒ–æœåŠ¡

ç›´æ¥è¿”å›å›åº”å†…å®¹ï¼Œä¸éœ€è¦é¢å¤–è¯´æ˜ã€‚`;

  // åŠ¨æ€ç”Ÿæˆç³»ç»Ÿæç¤ºè¯ï¼Œæ›¿æ¢é»˜è®¤çš„"å°è‰¾"åå­—
  const dynamicSystemPrompt = CONVERSATION_SYSTEM_PROMPT.replace(/å°è‰¾/g, assistantName);

  return {
    systemPrompt: dynamicSystemPrompt,
    userPrompt: userPrompt,
    messages: [
      { role: 'system', content: dynamicSystemPrompt },
      { role: 'user', content: userPrompt }
    ]
  };
}

/**
 * æ ¹æ®æƒ…ç»ªç±»å‹è·å–å›åº”æ¨¡æ¿
 * @param {String} emotion æƒ…ç»ªç±»å‹
 * @returns {String} éšæœºé€‰æ‹©çš„å›åº”æ¨¡æ¿
 */
function getEmotionResponse(emotion) {
  const templates = EMOTION_RESPONSE_TEMPLATES[emotion] || EMOTION_RESPONSE_TEMPLATES.neutral;
  const randomIndex = Math.floor(Math.random() * templates.length);
  return templates[randomIndex];
}

/**
 * è·å–è¯é¢˜å»¶ç»­æ¨¡æ¿
 * @param {String} type å»¶ç»­ç±»å‹
 * @returns {String} éšæœºé€‰æ‹©çš„å»¶ç»­æ¨¡æ¿
 */
function getTopicContinuation(type) {
  const templates = TOPIC_CONTINUATION_TEMPLATES[type] || TOPIC_CONTINUATION_TEMPLATES.encourage_sharing;
  const randomIndex = Math.floor(Math.random() * templates.length);
  return templates[randomIndex];
}

/**
 * åˆ†æç”¨æˆ·æ¶ˆæ¯ä¸­çš„æƒ…ç»ª
 * @param {String} message ç”¨æˆ·æ¶ˆæ¯
 * @param {Array} keywords æå–çš„å…³é”®è¯
 * @returns {String} æ£€æµ‹åˆ°çš„ä¸»è¦æƒ…ç»ª
 */
function detectEmotion(message, keywords = []) {
  const emotionKeywords = {
    happy: ['å¼€å¿ƒ', 'é«˜å…´', 'å¿«ä¹', 'å…´å¥‹', 'å“ˆå“ˆ', 'ğŸ˜Š', 'ğŸ˜„', 'ğŸ‰'],
    sad: ['éš¾è¿‡', 'ä¼¤å¿ƒ', 'æ²®ä¸§', 'å¤±è½', 'å“­', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ’”'],
    tired: ['ç´¯', 'ç–²æƒ«', 'å›°', 'è¾›è‹¦', 'å¿™', 'ğŸ˜´', 'ğŸ’¤'],
    stressed: ['å‹åŠ›', 'ç„¦è™‘', 'ç´§å¼ ', 'æ‹…å¿ƒ', 'æ„', 'ğŸ˜°', 'ğŸ˜Ÿ'],
    frustrated: ['çƒ¦', 'æ°”', 'éƒé—·', 'æ— å¥ˆ', 'çƒ¦èº', 'ğŸ˜¤', 'ğŸ˜ '],
    excited: ['æ¿€åŠ¨', 'å…´å¥‹', 'æ£’', 'å¤ªå¥½äº†', 'å“‡', 'ğŸ‰', 'âœ¨'],
    confused: ['ä¸æ‡‚', 'å›°æƒ‘', 'è¿·èŒ«', 'ä¸æ˜ç™½', 'æä¸æ¸…', 'ğŸ¤”']
  };
  
  const text = message.toLowerCase() + ' ' + keywords.join(' ').toLowerCase();
  
  for (const [emotion, words] of Object.entries(emotionKeywords)) {
    if (words.some(word => text.includes(word))) {
      return emotion;
    }
  }
  
  return 'neutral';
}

/**
 * éªŒè¯å¯¹è¯è¾“å…¥
 * @param {String} message ç”¨æˆ·æ¶ˆæ¯
 * @returns {Object} éªŒè¯ç»“æœ
 */
function validateConversationInput(message) {
  if (!message || typeof message !== 'string') {
    return {
      isValid: false,
      error: 'æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º'
    };
  }
  
  if (message.trim().length === 0) {
    return {
      isValid: false,
      error: 'æ¶ˆæ¯å†…å®¹ä¸èƒ½ä¸ºç©º'
    };
  }
  
  if (message.length > 2000) {
    return {
      isValid: false,
      error: 'æ¶ˆæ¯å†…å®¹è¿‡é•¿ï¼Œè¯·æ§åˆ¶åœ¨2000å­—ç¬¦ä»¥å†…'
    };
  }
  
  return {
    isValid: true
  };
}

module.exports = {
  CONVERSATION_SYSTEM_PROMPT,
  EMOTION_RESPONSE_TEMPLATES,
  TOPIC_CONTINUATION_TEMPLATES,
  buildConversationPrompt,
  getEmotionResponse,
  getTopicContinuation,
  detectEmotion,
  validateConversationInput
};

