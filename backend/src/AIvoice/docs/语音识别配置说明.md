# 语音识别功能配置说明

## 概述
本模块提供了基于阿里云通义千问ASR和Paraformer模型的语音识别功能，支持用户上传语音文件并转换为文本。

## 环境变量配置

### 必需配置
```bash
# 阿里云DashScope API密钥（用于语音识别）
DASHSCOPE_API_KEY=your_dashscope_api_key_here

# OSS配置（用于存储音频文件）
OSS_REGION=oss-cn-hangzhou
OSS_ACCESS_KEY_ID=your_oss_access_key_id
OSS_ACCESS_KEY_SECRET=your_oss_access_key_secret
OSS_BUCKET=your_oss_bucket_name
```

### 获取DashScope API密钥
1. 访问 [阿里云DashScope控制台](https://dashscope.console.aliyun.com/)
2. 创建API密钥
3. 将密钥配置到环境变量中

## API接口说明

### 1. 完整语音识别接口
**接口地址：** `POST /api/speech-recognition/recognize`

**功能：** 上传语音文件到OSS，然后直接进行语音识别

**请求参数：**
- `audio`: 音频文件（支持MP3, WAV, M4A, AAC, FLAC格式）
- 文件大小限制：10MB
- 时长限制：3分钟

**响应示例：**
```json
{
  "success": true,
  "data": {
    "transcription": "识别出的文本内容",
    "audioUrl": "https://your-bucket.oss-cn-hangzhou.aliyuncs.com/...",
    "ossKey": "speech-recognition/userId/timestamp_filename.mp3"
  },
  "message": "语音识别成功"
}
```

### 2. 仅上传语音文件接口
**接口地址：** `POST /api/speech-recognition/upload`

**功能：** 仅上传语音文件到OSS，不进行识别

**响应示例：**
```json
{
  "success": true,
  "data": {
    "audioUrl": "https://your-bucket.oss-cn-hangzhou.aliyuncs.com/...",
    "ossKey": "speech-recognition/userId/timestamp_filename.mp3"
  },
  "message": "语音文件上传成功"
}
```

### 3. 从URL识别接口
**接口地址：** `POST /api/speech-recognition/recognize-url`

**功能：** 对已上传的OSS文件进行语音识别

**请求参数：**
```json
{
  "audioUrl": "https://your-bucket.oss-cn-hangzhou.aliyuncs.com/..."
}
```

## 支持的音频格式

| 格式 | 扩展名 | 说明 |
|------|--------|------|
| MP3 | .mp3 | 最常用，推荐使用 |
| WAV | .wav | 无损格式，文件较大 |
| M4A | .m4a | AAC编码的MP4音频 |
| AAC | .aac | 高质量压缩格式 |
| FLAC | .flac | 无损压缩格式 |

## 模型选择策略

### 主要模型：通义千问ASR
- **优势：** 支持本地文件、流式输出、中文和英语效果好
- **限制：** 文件大小10MB，时长3分钟
- **适用场景：** 中文普通话、英语语音识别

### 备用模型：Paraformer-v2
- **优势：** 支持更多语言、方言、热词定制
- **限制：** 仅支持URL输入
- **适用场景：** 方言、其他语言、需要热词定制的场景

## 错误处理

### 常见错误码
- `400`: 请求参数错误（如缺少音频文件）
- `401`: 未认证或认证失败
- `500`: 服务器内部错误（如语音识别失败）

### 错误响应格式
```json
{
  "success": false,
  "error": "错误描述",
  "detail": "详细错误信息"
}
```

## 使用流程

### 推荐流程（一步到位）
1. 用户上传音频文件
2. 系统自动上传到OSS
3. 调用语音识别服务
4. 返回识别结果
5. 清理临时文件

### 分步流程（适用于大文件或复杂场景）
1. 用户上传音频文件到OSS
2. 系统返回OSS URL
3. 用户选择时机调用识别接口
4. 返回识别结果

## 性能优化建议

1. **文件预处理：** 建议将音频转换为16kHz采样率，单声道
2. **文件大小：** 控制在10MB以内，避免超时
3. **并发控制：** 避免同时处理过多大文件
4. **缓存策略：** 对于相同内容，可以考虑缓存识别结果

## 测试

### 运行测试
```bash
# 进入项目目录
cd backend

# 运行语音识别测试
node src/AIvoice/tests/speech-recognition-test.js
```

### 测试前准备
1. 确保服务器正在运行
2. 配置有效的测试token
3. 配置所有必需的环境变量
4. 准备测试音频文件

## 注意事项

1. **认证要求：** 所有接口都需要有效的JWT token
2. **文件清理：** 系统会自动清理临时文件，但OSS文件需要手动管理
3. **API限制：** 注意DashScope的API调用频率限制
4. **成本控制：** OSS存储和API调用都会产生费用，建议定期清理不需要的文件

## 故障排除

### 常见问题
1. **API密钥无效：** 检查DASHSCOPE_API_KEY是否正确
2. **OSS上传失败：** 检查OSS配置和网络连接
3. **识别超时：** 检查文件大小和网络状况
4. **格式不支持：** 确保使用支持的音频格式

### 日志查看
语音识别相关的日志会记录在：
- `logs/combined.log` - 一般信息
- `logs/error.log` - 错误信息
