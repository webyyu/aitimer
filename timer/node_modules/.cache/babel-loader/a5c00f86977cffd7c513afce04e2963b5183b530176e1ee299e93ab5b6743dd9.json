{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.for-each.js\";\n/**\n * AIsiri 智能调度消息处理服务\n * 处理聊天消息的格式化、存储和状态管理\n */\n\nimport aisiriService from './aiApi.js';\nimport { MESSAGE_TYPES, SENDERS } from '../types/index.js';\n\n/**\n * 生成唯一消息ID\n */\nfunction generateMessageId() {\n  return `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n}\n\n/**\n * 创建消息对象\n */\nfunction createMessage(content, sender = SENDERS.AI, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n  return {\n    id: generateMessageId(),\n    content,\n    sender,\n    type,\n    timestamp: new Date(),\n    metadata,\n    isUser: sender === SENDERS.USER\n  };\n}\n\n/**\n * 消息服务类\n */\nclass MessageService {\n  constructor() {\n    this.messages = [];\n    this.isProcessing = false;\n    this.currentSessionId = null;\n    this.historyLoaded = false;\n    this.initialized = false;\n    console.log('💬 AIsiri智能调度消息服务初始化完成');\n  }\n\n  /**\n   * 初始化服务（仅在首次使用时调用）\n   */\n  async initialize() {\n    if (this.initialized) {\n      console.log('📋 MessageService已初始化，跳过重复初始化');\n      return;\n    }\n    console.log('🚀 开始初始化MessageService');\n    this.initialized = true;\n  }\n\n  /**\n   * 添加欢迎消息\n   */\n  addWelcomeMessage() {\n    const welcomeMessage = createMessage('你好！我是你的AI智能助手。我可以帮助你创建任务、安排日程、提供情绪支持，以及调用各种外部工具。请告诉我你需要什么帮助？', SENDERS.AI, MESSAGE_TYPES.TEXT);\n    this.messages.push(welcomeMessage);\n  }\n\n  /**\n   * 从后端加载聊天历史\n   */\n  async loadChatHistory(sessionId = null) {\n    try {\n      console.log('📚 开始加载聊天历史', {\n        sessionId\n      });\n\n      // 获取token\n      const token = localStorage.getItem('token');\n      if (!token) {\n        console.warn('⚠️ 未找到认证token，跳过历史加载');\n        this.addWelcomeMessage();\n        this.historyLoaded = true;\n        return;\n      }\n\n      // 构建API请求\n      const url = sessionId ? `/api/ai/conversation/history?sessionId=${sessionId}&limit=50` : '/api/ai/conversation/history?limit=50';\n      const response = await fetch(url, {\n        method: 'GET',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n          'Content-Type': 'application/json'\n        }\n      });\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n      const data = await response.json();\n      if (data.success && data.data && data.data.conversations) {\n        const conversations = data.data.conversations;\n        console.log(`📥 成功加载 ${conversations.length} 条聊天记录`);\n\n        // 清空现有消息\n        this.messages = [];\n\n        // 转换后端数据为前端消息格式\n        conversations.forEach(conv => {\n          const message = createMessage(conv.content, conv.messageType === 'user' ? SENDERS.USER : SENDERS.AI, MESSAGE_TYPES.TEXT, {\n            timestamp: new Date(conv.createdAt),\n            intent: conv.intent,\n            confidence: conv.intentConfidence,\n            sessionId: conv.sessionId\n          });\n          // 使用原始时间戳\n          message.timestamp = new Date(conv.createdAt);\n          this.messages.push(message);\n        });\n\n        // 如果没有历史记录，添加欢迎消息\n        if (conversations.length === 0) {\n          this.addWelcomeMessage();\n        }\n\n        // 设置当前会话ID\n        if (conversations.length > 0) {\n          this.currentSessionId = conversations[0].sessionId;\n        }\n      } else {\n        console.warn('⚠️ 后端返回数据格式异常', data);\n        this.addWelcomeMessage();\n      }\n      this.historyLoaded = true;\n      console.log('✅ 聊天历史加载完成');\n    } catch (error) {\n      console.error('❌ 加载聊天历史失败:', error);\n      // 加载失败时显示欢迎消息\n      this.messages = [];\n      this.addWelcomeMessage();\n      this.historyLoaded = true;\n    }\n  }\n\n  /**\n   * 检查是否已加载历史记录\n   */\n  isHistoryLoaded() {\n    return this.historyLoaded;\n  }\n\n  /**\n   * 获取所有消息\n   */\n  getMessages() {\n    return [...this.messages];\n  }\n\n  /**\n   * 添加用户消息\n   */\n  addUserMessage(content, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n    // 检查是否是图片消息\n    let messageType = type;\n    if (content && content.startsWith('🖼️ 图片：')) {\n      messageType = 'IMAGE'; // 使用自定义图片类型\n    }\n    const message = createMessage(content, SENDERS.USER, messageType, metadata);\n    this.messages.push(message);\n    console.log(`📝 用户消息: ${content}`);\n    return message;\n  }\n\n  /**\n   * 添加AI消息\n   */\n  addAIMessage(content, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n    const message = createMessage(content, SENDERS.AI, type, metadata);\n    this.messages.push(message);\n    console.log(`🤖 AI回复: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`);\n    return message;\n  }\n\n  /**\n   * 添加AI回复（不触发智能调度）\n   */\n  addAIReply(content, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n    const message = createMessage(content, SENDERS.AI, type, metadata);\n    this.messages.push(message);\n    console.log(`🤖 AI直接回复: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`);\n    return message;\n  }\n\n  /**\n   * 添加语音消息\n   */\n  addVoiceMessage(voiceData, isUser = false) {\n    const message = {\n      id: Date.now() + Math.random(),\n      type: MESSAGE_TYPES.VOICE,\n      isUser: isUser,\n      timestamp: new Date(),\n      duration: voiceData.transcription ? Math.ceil(voiceData.transcription.length / 5) : 3,\n      // 根据文字长度估算时长\n      transcription: voiceData.transcription || '',\n      audioUrl: voiceData.audioUrl || '',\n      audioFile: voiceData.audioFile || null\n    };\n    this.messages.push(message);\n    console.log(`🎤 ${isUser ? '用户' : 'AI'}语音消息已添加: ${voiceData.transcription?.substring(0, 50) || '无文字'}...`);\n    return message;\n  }\n\n  /**\n   * 添加系统消息\n   */\n  addSystemMessage(content) {\n    const message = createMessage(content, SENDERS.SYSTEM, MESSAGE_TYPES.TEXT);\n    this.messages.push(message);\n    console.log(`⚙️  系统消息: ${content}`);\n    return message;\n  }\n\n  /**\n   * 处理用户输入的主要方法 - 使用智能调度系统\n   */\n  async processUserInput(userInput) {\n    if (this.isProcessing) {\n      console.log('⏳ 正在处理中，请稍等...');\n      return;\n    }\n    try {\n      this.isProcessing = true;\n\n      // 1. 添加用户消息\n      this.addUserMessage(userInput);\n\n      // 2. 调用AIsiri智能调度\n      console.log('\\n🚀 开始智能调度处理...');\n      const response = await aisiriService.dispatch(userInput, this.currentSessionId);\n\n      // 3. 处理智能调度响应\n      await this.handleDispatchResponse(response);\n    } catch (error) {\n      console.error('❌ 智能调度处理失败:', error);\n      this.addAIMessage('抱歉，我遇到了一些技术问题。请稍后再试，或者尝试重新描述你的需求。', MESSAGE_TYPES.ERROR, {\n        error: error.message\n      });\n    } finally {\n      this.isProcessing = false;\n    }\n  }\n\n  /**\n   * 处理用户语音输入 - 返回语音回复\n   */\n  async processVoiceInput(voiceData) {\n    if (this.isProcessing) {\n      console.log('⏳ 正在处理中，请稍等...');\n      return;\n    }\n    try {\n      this.isProcessing = true;\n\n      // 1. 添加用户语音消息\n      this.addVoiceMessage(voiceData, true); // true表示是用户消息\n\n      // 2. 调用AIsiri智能调度\n      console.log('\\n🚀 开始智能调度处理语音输入...');\n      const response = await aisiriService.dispatch(voiceData.transcription, this.currentSessionId);\n\n      // 3. 处理智能调度响应，生成语音回复\n      await this.handleVoiceDispatchResponse(response, voiceData);\n    } catch (error) {\n      console.error('❌ 语音智能调度处理失败:', error);\n      this.addVoiceMessage({\n        transcription: '抱歉，我遇到了一些技术问题。请稍后再试，或者尝试重新描述你的需求。',\n        duration: 3,\n        isUser: false\n      }, false); // false表示是AI消息\n    } finally {\n      this.isProcessing = false;\n    }\n  }\n\n  /**\n   * 处理语音智能调度响应 - AI回复保持文字形式\n   */\n  async handleVoiceDispatchResponse(response, originalVoiceData) {\n    if (!response.success) {\n      // 处理错误响应\n      const errorMessage = response.error || '抱歉，系统遇到了问题。';\n      this.addAIMessage(errorMessage, MESSAGE_TYPES.ERROR, {\n        apiError: response.error\n      });\n      return;\n    }\n    const {\n      data\n    } = response;\n\n    // AI回复保持文字形式，不转换为语音\n    this.addAIMessage(data.response, MESSAGE_TYPES.TEXT, {\n      intents: data.intents,\n      servicesExecuted: data.servicesExecuted,\n      taskCreated: data.taskCreated,\n      scheduleAdjusted: data.scheduleAdjusted,\n      emotionalSupport: data.emotionalSupport,\n      processingTime: response.processingTime,\n      isVoiceInput: true // 标记这是来自语音输入的回复\n    });\n\n    // 如果有任务创建，添加任务创建消息\n    if (data.taskCreated) {\n      this.addTaskCreatedMessage(data.taskCreated);\n    }\n\n    // 如果有日程调整，添加日程调整消息\n    if (data.scheduleAdjusted) {\n      this.addScheduleAdjustedMessage(data.scheduleAdjusted);\n    }\n\n    // 通知任务页刷新（如果有任务相关操作）\n    if (data.taskCreated || data.scheduleAdjusted) {\n      try {\n        window.dispatchEvent(new CustomEvent('ai-dispatch-completed', {\n          detail: {\n            taskCreated: data.taskCreated,\n            scheduleAdjusted: data.scheduleAdjusted,\n            intents: data.intents\n          }\n        }));\n      } catch (_) {\n        // noop: 部分环境下 window 不可用\n      }\n    }\n  }\n\n  /**\n   * 处理智能调度响应\n   */\n  async handleDispatchResponse(response) {\n    if (!response.success) {\n      // 处理错误响应\n      const errorMessage = response.error || '抱歉，系统遇到了问题。';\n      this.addAIMessage(errorMessage, MESSAGE_TYPES.ERROR, {\n        apiError: response.error\n      });\n      return;\n    }\n    const {\n      data\n    } = response;\n\n    // 添加AI回复\n    this.addAIMessage(data.response, MESSAGE_TYPES.TEXT, {\n      intents: data.intents,\n      servicesExecuted: data.servicesExecuted,\n      taskCreated: data.taskCreated,\n      scheduleAdjusted: data.scheduleAdjusted,\n      emotionalSupport: data.emotionalSupport,\n      processingTime: response.processingTime\n    });\n\n    // 如果有任务创建，添加任务创建消息\n    if (data.taskCreated) {\n      this.addTaskCreatedMessage(data.taskCreated);\n    }\n\n    // 如果有日程调整，添加日程调整消息\n    if (data.scheduleAdjusted) {\n      this.addScheduleAdjustedMessage(data.scheduleAdjusted);\n    }\n\n    // 通知任务页刷新（如果有任务相关操作）\n    if (data.taskCreated || data.scheduleAdjusted) {\n      try {\n        window.dispatchEvent(new CustomEvent('ai-dispatch-completed', {\n          detail: {\n            taskCreated: data.taskCreated,\n            scheduleAdjusted: data.scheduleAdjusted,\n            intents: data.intents\n          }\n        }));\n      } catch (_) {\n        // noop: 部分环境下 window 不可用\n      }\n    }\n  }\n\n  /**\n   * 添加任务创建成功消息\n   */\n  addTaskCreatedMessage(task) {\n    let message = `✅ 任务已创建：${task.title}`;\n    if (task.scheduledTime) {\n      message += `，安排在 ${task.date} ${task.scheduledTime}`;\n    }\n    this.addAIMessage(message, MESSAGE_TYPES.TASK_CREATED, {\n      task: task\n    });\n  }\n\n  /**\n   * 添加日程调整消息\n   */\n  addScheduleAdjustedMessage(scheduleInfo) {\n    const message = '⏰ 日程已根据你的需求进行调整';\n    this.addAIMessage(message, MESSAGE_TYPES.SCHEDULE_ADJUSTED, {\n      scheduleInfo: scheduleInfo\n    });\n  }\n\n  /**\n   * 检查是否正在处理中\n   */\n  isCurrentlyProcessing() {\n    return this.isProcessing;\n  }\n\n  /**\n   * 获取当前会话ID\n   */\n  getCurrentSessionId() {\n    return this.currentSessionId;\n  }\n\n  /**\n   * 设置会话ID\n   */\n  setSessionId(sessionId) {\n    this.currentSessionId = sessionId;\n    console.log(`🔄 设置会话ID: ${sessionId}`);\n  }\n\n  /**\n   * 创建新会话\n   */\n  createNewSession() {\n    this.currentSessionId = aisiriService.createNewSession();\n    console.log(`🆕 创建新会话: ${this.currentSessionId}`);\n    return this.currentSessionId;\n  }\n\n  /**\n   * 清除所有消息\n   */\n  clearMessages() {\n    this.messages = [];\n    this.currentSessionId = null;\n    this.addWelcomeMessage();\n    console.log('🧹 消息历史已清除');\n  }\n\n  /**\n   * 导出消息历史（用于调试）\n   */\n  exportMessages() {\n    return {\n      messages: this.getMessages(),\n      sessionId: this.currentSessionId,\n      timestamp: new Date().toISOString()\n    };\n  }\n}\n\n// 创建单例实例\nconst messageService = new MessageService();\nexport default messageService;","map":{"version":3,"names":["aisiriService","MESSAGE_TYPES","SENDERS","generateMessageId","Date","now","Math","random","toString","substr","createMessage","content","sender","AI","type","TEXT","metadata","id","timestamp","isUser","USER","MessageService","constructor","messages","isProcessing","currentSessionId","historyLoaded","initialized","console","log","initialize","addWelcomeMessage","welcomeMessage","push","loadChatHistory","sessionId","token","localStorage","getItem","warn","url","response","fetch","method","headers","ok","Error","status","statusText","data","json","success","conversations","length","forEach","conv","message","messageType","createdAt","intent","confidence","intentConfidence","error","isHistoryLoaded","getMessages","addUserMessage","startsWith","addAIMessage","substring","addAIReply","addVoiceMessage","voiceData","VOICE","duration","transcription","ceil","audioUrl","audioFile","addSystemMessage","SYSTEM","processUserInput","userInput","dispatch","handleDispatchResponse","ERROR","processVoiceInput","handleVoiceDispatchResponse","originalVoiceData","errorMessage","apiError","intents","servicesExecuted","taskCreated","scheduleAdjusted","emotionalSupport","processingTime","isVoiceInput","addTaskCreatedMessage","addScheduleAdjustedMessage","window","dispatchEvent","CustomEvent","detail","_","task","title","scheduledTime","date","TASK_CREATED","scheduleInfo","SCHEDULE_ADJUSTED","isCurrentlyProcessing","getCurrentSessionId","setSessionId","createNewSession","clearMessages","exportMessages","toISOString","messageService"],"sources":["/Users/bytedance/Desktop/backend(2)/timer/src/AIsiri/services/messageService.js"],"sourcesContent":["/**\n * AIsiri 智能调度消息处理服务\n * 处理聊天消息的格式化、存储和状态管理\n */\n\nimport aisiriService from './aiApi.js'\nimport { MESSAGE_TYPES, SENDERS } from '../types/index.js'\n\n/**\n * 生成唯一消息ID\n */\nfunction generateMessageId() {\n  return `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\n}\n\n/**\n * 创建消息对象\n */\nfunction createMessage(content, sender = SENDERS.AI, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n  return {\n    id: generateMessageId(),\n    content,\n    sender,\n    type,\n    timestamp: new Date(),\n    metadata,\n    isUser: sender === SENDERS.USER\n  }\n}\n\n/**\n * 消息服务类\n */\nclass MessageService {\n  constructor() {\n    this.messages = []\n    this.isProcessing = false\n    this.currentSessionId = null\n    this.historyLoaded = false\n    this.initialized = false\n    \n    console.log('💬 AIsiri智能调度消息服务初始化完成')\n  }\n\n  /**\n   * 初始化服务（仅在首次使用时调用）\n   */\n  async initialize() {\n    if (this.initialized) {\n      console.log('📋 MessageService已初始化，跳过重复初始化')\n      return\n    }\n    \n    console.log('🚀 开始初始化MessageService')\n    this.initialized = true\n  }\n\n  /**\n   * 添加欢迎消息\n   */\n  addWelcomeMessage() {\n    const welcomeMessage = createMessage(\n      '你好！我是你的AI智能助手。我可以帮助你创建任务、安排日程、提供情绪支持，以及调用各种外部工具。请告诉我你需要什么帮助？',\n      SENDERS.AI,\n      MESSAGE_TYPES.TEXT\n    )\n    this.messages.push(welcomeMessage)\n  }\n\n  /**\n   * 从后端加载聊天历史\n   */\n  async loadChatHistory(sessionId = null) {\n    try {\n      console.log('📚 开始加载聊天历史', { sessionId })\n      \n      // 获取token\n      const token = localStorage.getItem('token')\n      if (!token) {\n        console.warn('⚠️ 未找到认证token，跳过历史加载')\n        this.addWelcomeMessage()\n        this.historyLoaded = true\n        return\n      }\n\n      // 构建API请求\n      const url = sessionId \n        ? `/api/ai/conversation/history?sessionId=${sessionId}&limit=50`\n        : '/api/ai/conversation/history?limit=50'\n      \n      const response = await fetch(url, {\n        method: 'GET',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n          'Content-Type': 'application/json'\n        }\n      })\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`)\n      }\n\n      const data = await response.json()\n      \n      if (data.success && data.data && data.data.conversations) {\n        const conversations = data.data.conversations\n        console.log(`📥 成功加载 ${conversations.length} 条聊天记录`)\n        \n        // 清空现有消息\n        this.messages = []\n        \n        // 转换后端数据为前端消息格式\n        conversations.forEach(conv => {\n          const message = createMessage(\n            conv.content,\n            conv.messageType === 'user' ? SENDERS.USER : SENDERS.AI,\n            MESSAGE_TYPES.TEXT,\n            {\n              timestamp: new Date(conv.createdAt),\n              intent: conv.intent,\n              confidence: conv.intentConfidence,\n              sessionId: conv.sessionId\n            }\n          )\n          // 使用原始时间戳\n          message.timestamp = new Date(conv.createdAt)\n          this.messages.push(message)\n        })\n        \n        // 如果没有历史记录，添加欢迎消息\n        if (conversations.length === 0) {\n          this.addWelcomeMessage()\n        }\n        \n        // 设置当前会话ID\n        if (conversations.length > 0) {\n          this.currentSessionId = conversations[0].sessionId\n        }\n        \n      } else {\n        console.warn('⚠️ 后端返回数据格式异常', data)\n        this.addWelcomeMessage()\n      }\n      \n      this.historyLoaded = true\n      console.log('✅ 聊天历史加载完成')\n      \n    } catch (error) {\n      console.error('❌ 加载聊天历史失败:', error)\n      // 加载失败时显示欢迎消息\n      this.messages = []\n      this.addWelcomeMessage()\n      this.historyLoaded = true\n    }\n  }\n\n  /**\n   * 检查是否已加载历史记录\n   */\n  isHistoryLoaded() {\n    return this.historyLoaded\n  }\n\n  /**\n   * 获取所有消息\n   */\n  getMessages() {\n    return [...this.messages]\n  }\n\n  /**\n   * 添加用户消息\n   */\n  addUserMessage(content, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n    // 检查是否是图片消息\n    let messageType = type\n    if (content && content.startsWith('🖼️ 图片：')) {\n      messageType = 'IMAGE' // 使用自定义图片类型\n    }\n    \n    const message = createMessage(content, SENDERS.USER, messageType, metadata)\n    this.messages.push(message)\n    \n    console.log(`📝 用户消息: ${content}`)\n    return message\n  }\n\n  /**\n   * 添加AI消息\n   */\n  addAIMessage(content, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n    const message = createMessage(content, SENDERS.AI, type, metadata)\n    this.messages.push(message)\n    \n    console.log(`🤖 AI回复: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`)\n    return message\n  }\n\n  /**\n   * 添加AI回复（不触发智能调度）\n   */\n  addAIReply(content, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n    const message = createMessage(content, SENDERS.AI, type, metadata)\n    this.messages.push(message)\n    \n    console.log(`🤖 AI直接回复: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`)\n    return message\n  }\n\n  /**\n   * 添加语音消息\n   */\n  addVoiceMessage(voiceData, isUser = false) {\n    const message = {\n      id: Date.now() + Math.random(),\n      type: MESSAGE_TYPES.VOICE,\n      isUser: isUser,\n      timestamp: new Date(),\n      duration: voiceData.transcription ? Math.ceil(voiceData.transcription.length / 5) : 3, // 根据文字长度估算时长\n      transcription: voiceData.transcription || '',\n      audioUrl: voiceData.audioUrl || '',\n      audioFile: voiceData.audioFile || null\n    }\n    \n    this.messages.push(message)\n    console.log(`🎤 ${isUser ? '用户' : 'AI'}语音消息已添加: ${voiceData.transcription?.substring(0, 50) || '无文字'}...`)\n    \n    return message\n  }\n\n  /**\n   * 添加系统消息\n   */\n  addSystemMessage(content) {\n    const message = createMessage(content, SENDERS.SYSTEM, MESSAGE_TYPES.TEXT)\n    this.messages.push(message)\n    \n    console.log(`⚙️  系统消息: ${content}`)\n    return message\n  }\n\n  /**\n   * 处理用户输入的主要方法 - 使用智能调度系统\n   */\n  async processUserInput(userInput) {\n    if (this.isProcessing) {\n      console.log('⏳ 正在处理中，请稍等...')\n      return\n    }\n\n    try {\n      this.isProcessing = true\n      \n      // 1. 添加用户消息\n      this.addUserMessage(userInput)\n      \n      // 2. 调用AIsiri智能调度\n      console.log('\\n🚀 开始智能调度处理...')\n      const response = await aisiriService.dispatch(userInput, this.currentSessionId)\n      \n      // 3. 处理智能调度响应\n      await this.handleDispatchResponse(response)\n      \n    } catch (error) {\n      console.error('❌ 智能调度处理失败:', error)\n      this.addAIMessage(\n        '抱歉，我遇到了一些技术问题。请稍后再试，或者尝试重新描述你的需求。',\n        MESSAGE_TYPES.ERROR,\n        { error: error.message }\n      )\n    } finally {\n      this.isProcessing = false\n    }\n  }\n\n  /**\n   * 处理用户语音输入 - 返回语音回复\n   */\n  async processVoiceInput(voiceData) {\n    if (this.isProcessing) {\n      console.log('⏳ 正在处理中，请稍等...')\n      return\n    }\n\n    try {\n      this.isProcessing = true\n      \n      // 1. 添加用户语音消息\n      this.addVoiceMessage(voiceData, true) // true表示是用户消息\n      \n      // 2. 调用AIsiri智能调度\n      console.log('\\n🚀 开始智能调度处理语音输入...')\n      const response = await aisiriService.dispatch(voiceData.transcription, this.currentSessionId)\n      \n      // 3. 处理智能调度响应，生成语音回复\n      await this.handleVoiceDispatchResponse(response, voiceData)\n      \n    } catch (error) {\n      console.error('❌ 语音智能调度处理失败:', error)\n      this.addVoiceMessage({\n        transcription: '抱歉，我遇到了一些技术问题。请稍后再试，或者尝试重新描述你的需求。',\n        duration: 3,\n        isUser: false\n      }, false) // false表示是AI消息\n    } finally {\n      this.isProcessing = false\n    }\n  }\n\n  /**\n   * 处理语音智能调度响应 - AI回复保持文字形式\n   */\n  async handleVoiceDispatchResponse(response, originalVoiceData) {\n    if (!response.success) {\n      // 处理错误响应\n      const errorMessage = response.error || '抱歉，系统遇到了问题。'\n      this.addAIMessage(errorMessage, MESSAGE_TYPES.ERROR, { apiError: response.error })\n      return\n    }\n\n    const { data } = response\n    \n    // AI回复保持文字形式，不转换为语音\n    this.addAIMessage(data.response, MESSAGE_TYPES.TEXT, {\n      intents: data.intents,\n      servicesExecuted: data.servicesExecuted,\n      taskCreated: data.taskCreated,\n      scheduleAdjusted: data.scheduleAdjusted,\n      emotionalSupport: data.emotionalSupport,\n      processingTime: response.processingTime,\n      isVoiceInput: true // 标记这是来自语音输入的回复\n    })\n    \n    // 如果有任务创建，添加任务创建消息\n    if (data.taskCreated) {\n      this.addTaskCreatedMessage(data.taskCreated)\n    }\n\n    // 如果有日程调整，添加日程调整消息\n    if (data.scheduleAdjusted) {\n      this.addScheduleAdjustedMessage(data.scheduleAdjusted)\n    }\n\n    // 通知任务页刷新（如果有任务相关操作）\n    if (data.taskCreated || data.scheduleAdjusted) {\n      try {\n        window.dispatchEvent(new CustomEvent('ai-dispatch-completed', {\n          detail: {\n            taskCreated: data.taskCreated,\n            scheduleAdjusted: data.scheduleAdjusted,\n            intents: data.intents\n          }\n        }))\n      } catch (_) {\n        // noop: 部分环境下 window 不可用\n      }\n    }\n  }\n\n  /**\n   * 处理智能调度响应\n   */\n  async handleDispatchResponse(response) {\n    if (!response.success) {\n      // 处理错误响应\n      const errorMessage = response.error || '抱歉，系统遇到了问题。'\n      this.addAIMessage(errorMessage, MESSAGE_TYPES.ERROR, { apiError: response.error })\n      return\n    }\n\n    const { data } = response\n    \n    // 添加AI回复\n    this.addAIMessage(data.response, MESSAGE_TYPES.TEXT, {\n      intents: data.intents,\n      servicesExecuted: data.servicesExecuted,\n      taskCreated: data.taskCreated,\n      scheduleAdjusted: data.scheduleAdjusted,\n      emotionalSupport: data.emotionalSupport,\n      processingTime: response.processingTime\n    })\n\n    // 如果有任务创建，添加任务创建消息\n    if (data.taskCreated) {\n      this.addTaskCreatedMessage(data.taskCreated)\n    }\n\n    // 如果有日程调整，添加日程调整消息\n    if (data.scheduleAdjusted) {\n      this.addScheduleAdjustedMessage(data.scheduleAdjusted)\n    }\n\n    // 通知任务页刷新（如果有任务相关操作）\n    if (data.taskCreated || data.scheduleAdjusted) {\n      try {\n        window.dispatchEvent(new CustomEvent('ai-dispatch-completed', {\n          detail: {\n            taskCreated: data.taskCreated,\n            scheduleAdjusted: data.scheduleAdjusted,\n            intents: data.intents\n          }\n        }))\n      } catch (_) {\n        // noop: 部分环境下 window 不可用\n      }\n    }\n  }\n\n  /**\n   * 添加任务创建成功消息\n   */\n  addTaskCreatedMessage(task) {\n    let message = `✅ 任务已创建：${task.title}`\n    if (task.scheduledTime) {\n      message += `，安排在 ${task.date} ${task.scheduledTime}`\n    }\n    \n    this.addAIMessage(message, MESSAGE_TYPES.TASK_CREATED, {\n      task: task\n    })\n  }\n\n  /**\n   * 添加日程调整消息\n   */\n  addScheduleAdjustedMessage(scheduleInfo) {\n    const message = '⏰ 日程已根据你的需求进行调整'\n    \n    this.addAIMessage(message, MESSAGE_TYPES.SCHEDULE_ADJUSTED, {\n      scheduleInfo: scheduleInfo\n    })\n  }\n\n  /**\n   * 检查是否正在处理中\n   */\n  isCurrentlyProcessing() {\n    return this.isProcessing\n  }\n\n  /**\n   * 获取当前会话ID\n   */\n  getCurrentSessionId() {\n    return this.currentSessionId\n  }\n\n  /**\n   * 设置会话ID\n   */\n  setSessionId(sessionId) {\n    this.currentSessionId = sessionId\n    console.log(`🔄 设置会话ID: ${sessionId}`)\n  }\n\n  /**\n   * 创建新会话\n   */\n  createNewSession() {\n    this.currentSessionId = aisiriService.createNewSession()\n    console.log(`🆕 创建新会话: ${this.currentSessionId}`)\n    return this.currentSessionId\n  }\n\n  /**\n   * 清除所有消息\n   */\n  clearMessages() {\n    this.messages = []\n    this.currentSessionId = null\n    this.addWelcomeMessage()\n    console.log('🧹 消息历史已清除')\n  }\n\n  /**\n   * 导出消息历史（用于调试）\n   */\n  exportMessages() {\n    return {\n      messages: this.getMessages(),\n      sessionId: this.currentSessionId,\n      timestamp: new Date().toISOString()\n    }\n  }\n}\n\n// 创建单例实例\nconst messageService = new MessageService()\n\nexport default messageService"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}