{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport aivoiceAPI from '@/api/aivoice.js';\nfunction resolveUserId() {\n  try {\n    const user = JSON.parse(localStorage.getItem('user') || 'null');\n    return user?._id || user?.id || localStorage.getItem('userId') || '';\n  } catch (_) {\n    return localStorage.getItem('userId') || '';\n  }\n}\nfunction toHttps(url) {\n  if (!url) return url;\n  return url.startsWith('http://') ? 'https://' + url.slice('http://'.length) : url;\n}\nfunction pickRandom(list) {\n  return list[Math.floor(Math.random() * list.length)];\n}\nfunction withBuster(url) {\n  const sep = url.includes('?') ? '&' : '?';\n  return `${url}${sep}t=${Date.now()}`;\n}\nasync function getVoiceUrls(kind) {\n  const userId = resolveUserId();\n  if (!userId) return [];\n  try {\n    const res = await aivoiceAPI.getBindStatus(userId);\n    if (res?.binded === false) return [];\n    const urls = [];\n    if (kind === 'encourage') {\n      if (res?.encourage_url) urls.push(toHttps(res.encourage_url));\n    } else {\n      if (res?.criticize_url) urls.push(toHttps(res.criticize_url));\n    }\n    const groups = Array.isArray(res?.voice_groups) ? res.voice_groups : [];\n    for (const g of groups) {\n      const u = kind === 'encourage' ? g?.encourage_url : g?.criticize_url;\n      if (u) urls.push(toHttps(u));\n    }\n    return urls.filter(Boolean);\n  } catch (_) {\n    return [];\n  }\n}\nfunction playWithRetry(url, maxAttempts = 3) {\n  return new Promise(resolve => {\n    let attempts = 0;\n    const tryPlay = () => {\n      attempts += 1;\n      const audio = new Audio(withBuster(url));\n      audio.preload = 'auto';\n      const cleanup = () => {\n        audio.oncanplaythrough = null;\n        audio.onerror = null;\n      };\n      audio.oncanplaythrough = async () => {\n        cleanup();\n        try {\n          await audio.play();\n        } catch (_) {/* ignore */}\n        resolve();\n      };\n      audio.onerror = () => {\n        cleanup();\n        if (attempts < maxAttempts) {\n          setTimeout(tryPlay, attempts * 600);\n        } else {\n          resolve();\n        }\n      };\n      // 立即触发加载\n      audio.load();\n    };\n    tryPlay();\n  });\n}\nexport async function playRandomVoice(kind) {\n  try {\n    const urls = await getVoiceUrls(kind);\n    if (!urls.length) return;\n    const url = pickRandom(urls);\n    await playWithRetry(url, 3);\n  } catch (_) {\n    void 0;\n  }\n}","map":{"version":3,"names":["aivoiceAPI","resolveUserId","user","JSON","parse","localStorage","getItem","_id","id","_","toHttps","url","startsWith","slice","length","pickRandom","list","Math","floor","random","withBuster","sep","includes","Date","now","getVoiceUrls","kind","userId","res","getBindStatus","binded","urls","encourage_url","push","criticize_url","groups","Array","isArray","voice_groups","g","u","filter","Boolean","playWithRetry","maxAttempts","Promise","resolve","attempts","tryPlay","audio","Audio","preload","cleanup","oncanplaythrough","onerror","play","setTimeout","load","playRandomVoice"],"sources":["/Users/bytedance/Desktop/backend(1) 3/timer/timer/src/aivoice/voicePlayer.js"],"sourcesContent":["import aivoiceAPI from '@/api/aivoice.js'\r\n\r\nfunction resolveUserId() {\r\n  try {\r\n    const user = JSON.parse(localStorage.getItem('user') || 'null')\r\n    return user?._id || user?.id || localStorage.getItem('userId') || ''\r\n  } catch (_) {\r\n    return localStorage.getItem('userId') || ''\r\n  }\r\n}\r\n\r\nfunction toHttps(url) {\r\n  if (!url) return url\r\n  return url.startsWith('http://') ? 'https://' + url.slice('http://'.length) : url\r\n}\r\n\r\nfunction pickRandom(list) {\r\n  return list[Math.floor(Math.random() * list.length)]\r\n}\r\n\r\nfunction withBuster(url) {\r\n  const sep = url.includes('?') ? '&' : '?'\r\n  return `${url}${sep}t=${Date.now()}`\r\n}\r\n\r\nasync function getVoiceUrls(kind) {\r\n  const userId = resolveUserId()\r\n  if (!userId) return []\r\n  try {\r\n    const res = await aivoiceAPI.getBindStatus(userId)\r\n    if (res?.binded === false) return []\r\n    const urls = []\r\n    if (kind === 'encourage') {\r\n      if (res?.encourage_url) urls.push(toHttps(res.encourage_url))\r\n    } else {\r\n      if (res?.criticize_url) urls.push(toHttps(res.criticize_url))\r\n    }\r\n    const groups = Array.isArray(res?.voice_groups) ? res.voice_groups : []\r\n    for (const g of groups) {\r\n      const u = kind === 'encourage' ? g?.encourage_url : g?.criticize_url\r\n      if (u) urls.push(toHttps(u))\r\n    }\r\n    return urls.filter(Boolean)\r\n  } catch (_) {\r\n    return []\r\n  }\r\n}\r\n\r\nfunction playWithRetry(url, maxAttempts = 3) {\r\n  return new Promise((resolve) => {\r\n    let attempts = 0\r\n    const tryPlay = () => {\r\n      attempts += 1\r\n      const audio = new Audio(withBuster(url))\r\n      audio.preload = 'auto'\r\n      const cleanup = () => {\r\n        audio.oncanplaythrough = null\r\n        audio.onerror = null\r\n      }\r\n      audio.oncanplaythrough = async () => {\r\n        cleanup()\r\n        try { await audio.play() } catch (_) { /* ignore */ }\r\n        resolve()\r\n      }\r\n      audio.onerror = () => {\r\n        cleanup()\r\n        if (attempts < maxAttempts) {\r\n          setTimeout(tryPlay, attempts * 600)\r\n        } else {\r\n          resolve()\r\n        }\r\n      }\r\n      // 立即触发加载\r\n      audio.load()\r\n    }\r\n    tryPlay()\r\n  })\r\n}\r\n\r\nexport async function playRandomVoice(kind) {\r\n  try {\r\n    const urls = await getVoiceUrls(kind)\r\n    if (!urls.length) return\r\n    const url = pickRandom(urls)\r\n    await playWithRetry(url, 3)\r\n  } catch (_) { void 0 }\r\n} "],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}