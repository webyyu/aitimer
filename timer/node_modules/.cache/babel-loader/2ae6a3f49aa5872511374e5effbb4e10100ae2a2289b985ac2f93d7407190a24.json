{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.for-each.js\";\n/**\n * AIsiri Êô∫ËÉΩË∞ÉÂ∫¶Ê∂àÊÅØÂ§ÑÁêÜÊúçÂä°\n * Â§ÑÁêÜËÅäÂ§©Ê∂àÊÅØÁöÑÊ†ºÂºèÂåñ„ÄÅÂ≠òÂÇ®ÂíåÁä∂ÊÄÅÁÆ°ÁêÜ\n */\n\nimport aisiriService from './aiApi.js';\nimport { MESSAGE_TYPES, SENDERS } from '../types/index.js';\n\n/**\n * ÁîüÊàêÂîØ‰∏ÄÊ∂àÊÅØID\n */\nfunction generateMessageId() {\n  return `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n}\n\n/**\n * ÂàõÂª∫Ê∂àÊÅØÂØπË±°\n */\nfunction createMessage(content, sender = SENDERS.AI, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n  return {\n    id: generateMessageId(),\n    content,\n    sender,\n    type,\n    timestamp: new Date(),\n    metadata,\n    isUser: sender === SENDERS.USER\n  };\n}\n\n/**\n * Ê∂àÊÅØÊúçÂä°Á±ª\n */\nclass MessageService {\n  constructor() {\n    this.messages = [];\n    this.isProcessing = false;\n    this.currentSessionId = null;\n    this.historyLoaded = false;\n    this.initialized = false;\n    console.log('üí¨ AIsiriÊô∫ËÉΩË∞ÉÂ∫¶Ê∂àÊÅØÊúçÂä°ÂàùÂßãÂåñÂÆåÊàê');\n  }\n\n  /**\n   * ÂàùÂßãÂåñÊúçÂä°Ôºà‰ªÖÂú®È¶ñÊ¨°‰ΩøÁî®Êó∂Ë∞ÉÁî®Ôºâ\n   */\n  async initialize() {\n    if (this.initialized) {\n      console.log('üìã MessageServiceÂ∑≤ÂàùÂßãÂåñÔºåË∑≥ËøáÈáçÂ§çÂàùÂßãÂåñ');\n      return;\n    }\n    console.log('üöÄ ÂºÄÂßãÂàùÂßãÂåñMessageService');\n    this.initialized = true;\n  }\n\n  /**\n   * Ê∑ªÂä†Ê¨¢ËøéÊ∂àÊÅØ\n   */\n  addWelcomeMessage() {\n    const welcomeMessage = createMessage('‰Ω†Â•ΩÔºÅÊàëÊòØ‰Ω†ÁöÑAIÊô∫ËÉΩÂä©Êâã„ÄÇÊàëÂèØ‰ª•Â∏ÆÂä©‰Ω†ÂàõÂª∫‰ªªÂä°„ÄÅÂÆâÊéíÊó•Á®ã„ÄÅÊèê‰æõÊÉÖÁª™ÊîØÊåÅÔºå‰ª•ÂèäË∞ÉÁî®ÂêÑÁßçÂ§ñÈÉ®Â∑•ÂÖ∑„ÄÇËØ∑ÂëäËØâÊàë‰Ω†ÈúÄË¶Å‰ªÄ‰πàÂ∏ÆÂä©Ôºü', SENDERS.AI, MESSAGE_TYPES.TEXT);\n    this.messages.push(welcomeMessage);\n  }\n\n  /**\n   * ‰ªéÂêéÁ´ØÂä†ËΩΩËÅäÂ§©ÂéÜÂè≤\n   */\n  async loadChatHistory(sessionId = null) {\n    try {\n      console.log('üìö ÂºÄÂßãÂä†ËΩΩËÅäÂ§©ÂéÜÂè≤', {\n        sessionId\n      });\n\n      // Ëé∑Âèñtoken\n      const token = localStorage.getItem('token');\n      if (!token) {\n        console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞ËÆ§ËØÅtokenÔºåË∑≥ËøáÂéÜÂè≤Âä†ËΩΩ');\n        this.addWelcomeMessage();\n        this.historyLoaded = true;\n        return;\n      }\n\n      // ÊûÑÂª∫APIËØ∑Ê±Ç\n      const url = sessionId ? `/api/ai/conversation/history?sessionId=${sessionId}&limit=50` : '/api/ai/conversation/history?limit=50';\n      const response = await fetch(url, {\n        method: 'GET',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n          'Content-Type': 'application/json'\n        }\n      });\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n      const data = await response.json();\n      if (data.success && data.data && data.data.conversations) {\n        const conversations = data.data.conversations;\n        console.log(`üì• ÊàêÂäüÂä†ËΩΩ ${conversations.length} Êù°ËÅäÂ§©ËÆ∞ÂΩï`);\n\n        // Ê∏ÖÁ©∫Áé∞ÊúâÊ∂àÊÅØ\n        this.messages = [];\n\n        // ËΩ¨Êç¢ÂêéÁ´ØÊï∞ÊçÆ‰∏∫ÂâçÁ´ØÊ∂àÊÅØÊ†ºÂºè\n        conversations.forEach(conv => {\n          const message = createMessage(conv.content, conv.messageType === 'user' ? SENDERS.USER : SENDERS.AI, MESSAGE_TYPES.TEXT, {\n            timestamp: new Date(conv.createdAt),\n            intent: conv.intent,\n            confidence: conv.intentConfidence,\n            sessionId: conv.sessionId\n          });\n          // ‰ΩøÁî®ÂéüÂßãÊó∂Èó¥Êà≥\n          message.timestamp = new Date(conv.createdAt);\n          this.messages.push(message);\n        });\n\n        // ÊåâÊó∂Èó¥Êà≥ÊéíÂ∫èÊ∂àÊÅØÔºåÁ°Æ‰øùËÅäÂ§©ËÆ∞ÂΩïÊåâÊ≠£Á°ÆÈ°∫Â∫èÊòæÁ§∫\n        this.messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));\n\n        // Â¶ÇÊûúÊ≤°ÊúâÂéÜÂè≤ËÆ∞ÂΩïÔºåÊ∑ªÂä†Ê¨¢ËøéÊ∂àÊÅØ\n        if (conversations.length === 0) {\n          this.addWelcomeMessage();\n        }\n\n        // ËÆæÁΩÆÂΩìÂâç‰ºöËØùID\n        if (conversations.length > 0) {\n          this.currentSessionId = conversations[0].sessionId;\n        }\n      } else {\n        console.warn('‚ö†Ô∏è ÂêéÁ´ØËøîÂõûÊï∞ÊçÆÊ†ºÂºèÂºÇÂ∏∏', data);\n        this.addWelcomeMessage();\n      }\n      this.historyLoaded = true;\n      console.log('‚úÖ ËÅäÂ§©ÂéÜÂè≤Âä†ËΩΩÂÆåÊàê');\n    } catch (error) {\n      console.error('‚ùå Âä†ËΩΩËÅäÂ§©ÂéÜÂè≤Â§±Ë¥•:', error);\n      // Âä†ËΩΩÂ§±Ë¥•Êó∂ÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØ\n      this.messages = [];\n      this.addWelcomeMessage();\n      this.historyLoaded = true;\n    }\n  }\n\n  /**\n   * Ê£ÄÊü•ÊòØÂê¶Â∑≤Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï\n   */\n  isHistoryLoaded() {\n    return this.historyLoaded;\n  }\n\n  /**\n   * Ëé∑ÂèñÊâÄÊúâÊ∂àÊÅØ\n   */\n  getMessages() {\n    return [...this.messages];\n  }\n\n  /**\n   * Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ\n   */\n  async addUserMessage(content, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n    // Ê£ÄÊü•ÊòØÂê¶ÊòØÂõæÁâáÊ∂àÊÅØ\n    let messageType = type;\n    if (content && content.startsWith('üñºÔ∏è ÂõæÁâáÔºö')) {\n      messageType = 'IMAGE'; // ‰ΩøÁî®Ëá™ÂÆö‰πâÂõæÁâáÁ±ªÂûã\n    }\n    const message = createMessage(content, SENDERS.USER, messageType, metadata);\n    this.messages.push(message);\n    console.log(`üìù Áî®Êà∑Ê∂àÊÅØ: ${content}`);\n\n    // ‰øùÂ≠òÁî®Êà∑Ê∂àÊÅØÂà∞ÂêéÁ´ØÊï∞ÊçÆÂ∫ì\n    try {\n      await this.saveMessageToBackend(message, 'user');\n    } catch (error) {\n      console.error('‚ùå ‰øùÂ≠òÁî®Êà∑Ê∂àÊÅØÂà∞ÂêéÁ´ØÂ§±Ë¥•:', error);\n      // ‰∏çÂΩ±ÂìçÂâçÁ´ØÊòæÁ§∫ÔºåÂè™ËÆ∞ÂΩïÈîôËØØ\n    }\n    return message;\n  }\n\n  /**\n   * ‰øùÂ≠òÊ∂àÊÅØÂà∞ÂêéÁ´ØÊï∞ÊçÆÂ∫ì\n   */\n  async saveMessageToBackend(message, messageType) {\n    try {\n      const token = localStorage.getItem('token');\n      if (!token) {\n        console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞ËÆ§ËØÅtokenÔºåË∑≥ËøáÊ∂àÊÅØ‰øùÂ≠ò');\n        return;\n      }\n      const response = await fetch('/api/ai/conversation/save', {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          content: message.content,\n          messageType: messageType,\n          sessionId: this.currentSessionId || this.createNewSession(),\n          intent: message.metadata?.intent,\n          intentConfidence: message.metadata?.confidence,\n          timestamp: message.timestamp\n        })\n      });\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n      const data = await response.json();\n      if (data.success) {\n        console.log(`üíæ Ê∂àÊÅØÂ∑≤‰øùÂ≠òÂà∞ÂêéÁ´Ø: ${messageType}`);\n      } else {\n        throw new Error(data.message || '‰øùÂ≠òÂ§±Ë¥•');\n      }\n    } catch (error) {\n      console.error('‚ùå ‰øùÂ≠òÊ∂àÊÅØÂà∞ÂêéÁ´ØÂ§±Ë¥•:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Ê∑ªÂä†AIÊ∂àÊÅØ\n   */\n  async addAIMessage(content, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n    const message = createMessage(content, SENDERS.AI, type, metadata);\n    this.messages.push(message);\n    console.log(`ü§ñ AIÂõûÂ§ç: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`);\n\n    // ‰øùÂ≠òAIÊ∂àÊÅØÂà∞ÂêéÁ´ØÊï∞ÊçÆÂ∫ì\n    try {\n      await this.saveMessageToBackend(message, 'ai');\n    } catch (error) {\n      console.error('‚ùå ‰øùÂ≠òAIÊ∂àÊÅØÂà∞ÂêéÁ´ØÂ§±Ë¥•:', error);\n      // ‰∏çÂΩ±ÂìçÂâçÁ´ØÊòæÁ§∫ÔºåÂè™ËÆ∞ÂΩïÈîôËØØ\n    }\n    return message;\n  }\n\n  /**\n   * Ê∑ªÂä†AIÂõûÂ§çÔºà‰∏çËß¶ÂèëÊô∫ËÉΩË∞ÉÂ∫¶Ôºâ\n   */\n  addAIReply(content, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n    const message = createMessage(content, SENDERS.AI, type, metadata);\n    this.messages.push(message);\n    console.log(`ü§ñ AIÁõ¥Êé•ÂõûÂ§ç: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`);\n    return message;\n  }\n\n  /**\n   * Ê∑ªÂä†ËØ≠Èü≥Ê∂àÊÅØ\n   */\n  addVoiceMessage(voiceData, isUser = false) {\n    const message = {\n      id: Date.now() + Math.random(),\n      type: MESSAGE_TYPES.VOICE,\n      isUser: isUser,\n      timestamp: new Date(),\n      duration: voiceData.transcription ? Math.ceil(voiceData.transcription.length / 5) : 3,\n      // Ê†πÊçÆÊñáÂ≠óÈïøÂ∫¶‰º∞ÁÆóÊó∂Èïø\n      transcription: voiceData.transcription || '',\n      audioUrl: voiceData.audioUrl || '',\n      audioFile: voiceData.audioFile || null\n    };\n    this.messages.push(message);\n    console.log(`üé§ ${isUser ? 'Áî®Êà∑' : 'AI'}ËØ≠Èü≥Ê∂àÊÅØÂ∑≤Ê∑ªÂä†: ${voiceData.transcription?.substring(0, 50) || 'Êó†ÊñáÂ≠ó'}...`);\n    return message;\n  }\n\n  /**\n   * Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØ\n   */\n  addSystemMessage(content) {\n    const message = createMessage(content, SENDERS.SYSTEM, MESSAGE_TYPES.TEXT);\n    this.messages.push(message);\n    console.log(`‚öôÔ∏è  Á≥ªÁªüÊ∂àÊÅØ: ${content}`);\n    return message;\n  }\n\n  /**\n   * Â§ÑÁêÜÁî®Êà∑ËæìÂÖ•ÁöÑ‰∏ªË¶ÅÊñπÊ≥ï - ‰ΩøÁî®Êô∫ËÉΩË∞ÉÂ∫¶Á≥ªÁªü\n   */\n  async processUserInput(userInput) {\n    if (this.isProcessing) {\n      console.log('‚è≥ Ê≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåËØ∑Á®çÁ≠â...');\n      return;\n    }\n    try {\n      this.isProcessing = true;\n\n      // 1. Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ\n      this.addUserMessage(userInput);\n\n      // 2. Ë∞ÉÁî®AIsiriÊô∫ËÉΩË∞ÉÂ∫¶\n      console.log('\\nüöÄ ÂºÄÂßãÊô∫ËÉΩË∞ÉÂ∫¶Â§ÑÁêÜ...');\n      const response = await aisiriService.dispatch(userInput, this.currentSessionId);\n\n      // 3. Â§ÑÁêÜÊô∫ËÉΩË∞ÉÂ∫¶ÂìçÂ∫î\n      await this.handleDispatchResponse(response);\n    } catch (error) {\n      console.error('‚ùå Êô∫ËÉΩË∞ÉÂ∫¶Â§ÑÁêÜÂ§±Ë¥•:', error);\n      this.addAIMessage('Êä±Ê≠âÔºåÊàëÈÅáÂà∞‰∫Ü‰∏Ä‰∫õÊäÄÊúØÈóÆÈ¢ò„ÄÇËØ∑Á®çÂêéÂÜçËØïÔºåÊàñËÄÖÂ∞ùËØïÈáçÊñ∞ÊèèËø∞‰Ω†ÁöÑÈúÄÊ±Ç„ÄÇ', MESSAGE_TYPES.ERROR, {\n        error: error.message\n      });\n    } finally {\n      this.isProcessing = false;\n    }\n  }\n\n  /**\n   * Â§ÑÁêÜÁî®Êà∑ËØ≠Èü≥ËæìÂÖ• - ËøîÂõûËØ≠Èü≥ÂõûÂ§ç\n   */\n  async processVoiceInput(voiceData) {\n    if (this.isProcessing) {\n      console.log('‚è≥ Ê≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåËØ∑Á®çÁ≠â...');\n      return;\n    }\n    try {\n      this.isProcessing = true;\n\n      // 1. Ê∑ªÂä†Áî®Êà∑ËØ≠Èü≥Ê∂àÊÅØ\n      this.addVoiceMessage(voiceData, true); // trueË°®Á§∫ÊòØÁî®Êà∑Ê∂àÊÅØ\n\n      // 2. Ë∞ÉÁî®AIsiriÊô∫ËÉΩË∞ÉÂ∫¶\n      console.log('\\nüöÄ ÂºÄÂßãÊô∫ËÉΩË∞ÉÂ∫¶Â§ÑÁêÜËØ≠Èü≥ËæìÂÖ•...');\n      const response = await aisiriService.dispatch(voiceData.transcription, this.currentSessionId);\n\n      // 3. Â§ÑÁêÜÊô∫ËÉΩË∞ÉÂ∫¶ÂìçÂ∫îÔºåÁîüÊàêËØ≠Èü≥ÂõûÂ§ç\n      await this.handleVoiceDispatchResponse(response, voiceData);\n    } catch (error) {\n      console.error('‚ùå ËØ≠Èü≥Êô∫ËÉΩË∞ÉÂ∫¶Â§ÑÁêÜÂ§±Ë¥•:', error);\n      this.addVoiceMessage({\n        transcription: 'Êä±Ê≠âÔºåÊàëÈÅáÂà∞‰∫Ü‰∏Ä‰∫õÊäÄÊúØÈóÆÈ¢ò„ÄÇËØ∑Á®çÂêéÂÜçËØïÔºåÊàñËÄÖÂ∞ùËØïÈáçÊñ∞ÊèèËø∞‰Ω†ÁöÑÈúÄÊ±Ç„ÄÇ',\n        duration: 3,\n        isUser: false\n      }, false); // falseË°®Á§∫ÊòØAIÊ∂àÊÅØ\n    } finally {\n      this.isProcessing = false;\n    }\n  }\n\n  /**\n   * Â§ÑÁêÜËØ≠Èü≥Êô∫ËÉΩË∞ÉÂ∫¶ÂìçÂ∫î - AIÂõûÂ§ç‰øùÊåÅÊñáÂ≠óÂΩ¢Âºè\n   */\n  async handleVoiceDispatchResponse(response, originalVoiceData) {\n    if (!response.success) {\n      // Â§ÑÁêÜÈîôËØØÂìçÂ∫î\n      const errorMessage = response.error || 'Êä±Ê≠âÔºåÁ≥ªÁªüÈÅáÂà∞‰∫ÜÈóÆÈ¢ò„ÄÇ';\n      this.addAIMessage(errorMessage, MESSAGE_TYPES.ERROR, {\n        apiError: response.error\n      });\n      return;\n    }\n    const {\n      data\n    } = response;\n\n    // AIÂõûÂ§ç‰øùÊåÅÊñáÂ≠óÂΩ¢ÂºèÔºå‰∏çËΩ¨Êç¢‰∏∫ËØ≠Èü≥\n    this.addAIMessage(data.response, MESSAGE_TYPES.TEXT, {\n      intents: data.intents,\n      servicesExecuted: data.servicesExecuted,\n      taskCreated: data.taskCreated,\n      scheduleAdjusted: data.scheduleAdjusted,\n      emotionalSupport: data.emotionalSupport,\n      processingTime: response.processingTime,\n      isVoiceInput: true // Ê†áËÆ∞ËøôÊòØÊù•Ëá™ËØ≠Èü≥ËæìÂÖ•ÁöÑÂõûÂ§ç\n    });\n\n    // Â¶ÇÊûúÊúâ‰ªªÂä°ÂàõÂª∫ÔºåÊ∑ªÂä†‰ªªÂä°ÂàõÂª∫Ê∂àÊÅØ\n    if (data.taskCreated) {\n      this.addTaskCreatedMessage(data.taskCreated);\n    }\n\n    // Â¶ÇÊûúÊúâÊó•Á®ãË∞ÉÊï¥ÔºåÊ∑ªÂä†Êó•Á®ãË∞ÉÊï¥Ê∂àÊÅØ\n    if (data.scheduleAdjusted) {\n      this.addScheduleAdjustedMessage(data.scheduleAdjusted);\n    }\n\n    // ÈÄöÁü•‰ªªÂä°È°µÂà∑Êñ∞ÔºàÂ¶ÇÊûúÊúâ‰ªªÂä°Áõ∏ÂÖ≥Êìç‰ΩúÔºâ\n    if (data.taskCreated || data.scheduleAdjusted) {\n      try {\n        window.dispatchEvent(new CustomEvent('ai-dispatch-completed', {\n          detail: {\n            taskCreated: data.taskCreated,\n            scheduleAdjusted: data.scheduleAdjusted,\n            intents: data.intents\n          }\n        }));\n      } catch (_) {\n        // noop: ÈÉ®ÂàÜÁéØÂ¢É‰∏ã window ‰∏çÂèØÁî®\n      }\n    }\n  }\n\n  /**\n   * Â§ÑÁêÜÊô∫ËÉΩË∞ÉÂ∫¶ÂìçÂ∫î\n   */\n  async handleDispatchResponse(response) {\n    if (!response.success) {\n      // Â§ÑÁêÜÈîôËØØÂìçÂ∫î\n      const errorMessage = response.error || 'Êä±Ê≠âÔºåÁ≥ªÁªüÈÅáÂà∞‰∫ÜÈóÆÈ¢ò„ÄÇ';\n      this.addAIMessage(errorMessage, MESSAGE_TYPES.ERROR, {\n        apiError: response.error\n      });\n      return;\n    }\n    const {\n      data\n    } = response;\n\n    // Ê∑ªÂä†AIÂõûÂ§ç\n    this.addAIMessage(data.response, MESSAGE_TYPES.TEXT, {\n      intents: data.intents,\n      servicesExecuted: data.servicesExecuted,\n      taskCreated: data.taskCreated,\n      scheduleAdjusted: data.scheduleAdjusted,\n      emotionalSupport: data.emotionalSupport,\n      processingTime: response.processingTime\n    });\n\n    // Â¶ÇÊûúÊúâ‰ªªÂä°ÂàõÂª∫ÔºåÊ∑ªÂä†‰ªªÂä°ÂàõÂª∫Ê∂àÊÅØ\n    if (data.taskCreated) {\n      this.addTaskCreatedMessage(data.taskCreated);\n    }\n\n    // Â¶ÇÊûúÊúâÊó•Á®ãË∞ÉÊï¥ÔºåÊ∑ªÂä†Êó•Á®ãË∞ÉÊï¥Ê∂àÊÅØ\n    if (data.scheduleAdjusted) {\n      this.addScheduleAdjustedMessage(data.scheduleAdjusted);\n    }\n\n    // ÈÄöÁü•‰ªªÂä°È°µÂà∑Êñ∞ÔºàÂ¶ÇÊûúÊúâ‰ªªÂä°Áõ∏ÂÖ≥Êìç‰ΩúÔºâ\n    if (data.taskCreated || data.scheduleAdjusted) {\n      try {\n        window.dispatchEvent(new CustomEvent('ai-dispatch-completed', {\n          detail: {\n            taskCreated: data.taskCreated,\n            scheduleAdjusted: data.scheduleAdjusted,\n            intents: data.intents\n          }\n        }));\n      } catch (_) {\n        // noop: ÈÉ®ÂàÜÁéØÂ¢É‰∏ã window ‰∏çÂèØÁî®\n      }\n    }\n  }\n\n  /**\n   * Ê∑ªÂä†‰ªªÂä°ÂàõÂª∫ÊàêÂäüÊ∂àÊÅØ\n   */\n  addTaskCreatedMessage(task) {\n    let message = `‚úÖ ‰ªªÂä°Â∑≤ÂàõÂª∫Ôºö${task.title}`;\n    if (task.scheduledTime) {\n      message += `ÔºåÂÆâÊéíÂú® ${task.date} ${task.scheduledTime}`;\n    }\n    this.addAIMessage(message, MESSAGE_TYPES.TASK_CREATED, {\n      task: task\n    });\n  }\n\n  /**\n   * Ê∑ªÂä†Êó•Á®ãË∞ÉÊï¥Ê∂àÊÅØ\n   */\n  addScheduleAdjustedMessage(scheduleInfo) {\n    const message = '‚è∞ Êó•Á®ãÂ∑≤Ê†πÊçÆ‰Ω†ÁöÑÈúÄÊ±ÇËøõË°åË∞ÉÊï¥';\n    this.addAIMessage(message, MESSAGE_TYPES.SCHEDULE_ADJUSTED, {\n      scheduleInfo: scheduleInfo\n    });\n  }\n\n  /**\n   * Ê£ÄÊü•ÊòØÂê¶Ê≠£Âú®Â§ÑÁêÜ‰∏≠\n   */\n  isCurrentlyProcessing() {\n    return this.isProcessing;\n  }\n\n  /**\n   * Ëé∑ÂèñÂΩìÂâç‰ºöËØùID\n   */\n  getCurrentSessionId() {\n    return this.currentSessionId;\n  }\n\n  /**\n   * ËÆæÁΩÆ‰ºöËØùID\n   */\n  setSessionId(sessionId) {\n    this.currentSessionId = sessionId;\n    console.log(`üîÑ ËÆæÁΩÆ‰ºöËØùID: ${sessionId}`);\n  }\n\n  /**\n   * ÂàõÂª∫Êñ∞‰ºöËØù\n   */\n  createNewSession() {\n    this.currentSessionId = aisiriService.createNewSession();\n    console.log(`üÜï ÂàõÂª∫Êñ∞‰ºöËØù: ${this.currentSessionId}`);\n    return this.currentSessionId;\n  }\n\n  /**\n   * Ê∏ÖÈô§ÊâÄÊúâÊ∂àÊÅØ\n   */\n  clearMessages() {\n    this.messages = [];\n    this.currentSessionId = null;\n    this.addWelcomeMessage();\n    console.log('üßπ Ê∂àÊÅØÂéÜÂè≤Â∑≤Ê∏ÖÈô§');\n  }\n\n  /**\n   * ÂØºÂá∫Ê∂àÊÅØÂéÜÂè≤ÔºàÁî®‰∫éË∞ÉËØïÔºâ\n   */\n  exportMessages() {\n    return {\n      messages: this.getMessages(),\n      sessionId: this.currentSessionId,\n      timestamp: new Date().toISOString()\n    };\n  }\n}\n\n// ÂàõÂª∫Âçï‰æãÂÆû‰æã\nconst messageService = new MessageService();\nexport default messageService;","map":{"version":3,"names":["aisiriService","MESSAGE_TYPES","SENDERS","generateMessageId","Date","now","Math","random","toString","substr","createMessage","content","sender","AI","type","TEXT","metadata","id","timestamp","isUser","USER","MessageService","constructor","messages","isProcessing","currentSessionId","historyLoaded","initialized","console","log","initialize","addWelcomeMessage","welcomeMessage","push","loadChatHistory","sessionId","token","localStorage","getItem","warn","url","response","fetch","method","headers","ok","Error","status","statusText","data","json","success","conversations","length","forEach","conv","message","messageType","createdAt","intent","confidence","intentConfidence","sort","a","b","error","isHistoryLoaded","getMessages","addUserMessage","startsWith","saveMessageToBackend","body","JSON","stringify","createNewSession","addAIMessage","substring","addAIReply","addVoiceMessage","voiceData","VOICE","duration","transcription","ceil","audioUrl","audioFile","addSystemMessage","SYSTEM","processUserInput","userInput","dispatch","handleDispatchResponse","ERROR","processVoiceInput","handleVoiceDispatchResponse","originalVoiceData","errorMessage","apiError","intents","servicesExecuted","taskCreated","scheduleAdjusted","emotionalSupport","processingTime","isVoiceInput","addTaskCreatedMessage","addScheduleAdjustedMessage","window","dispatchEvent","CustomEvent","detail","_","task","title","scheduledTime","date","TASK_CREATED","scheduleInfo","SCHEDULE_ADJUSTED","isCurrentlyProcessing","getCurrentSessionId","setSessionId","clearMessages","exportMessages","toISOString","messageService"],"sources":["/Users/bytedance/Desktop/backend(2)/timer/src/AIsiri/services/messageService.js"],"sourcesContent":["/**\n * AIsiri Êô∫ËÉΩË∞ÉÂ∫¶Ê∂àÊÅØÂ§ÑÁêÜÊúçÂä°\n * Â§ÑÁêÜËÅäÂ§©Ê∂àÊÅØÁöÑÊ†ºÂºèÂåñ„ÄÅÂ≠òÂÇ®ÂíåÁä∂ÊÄÅÁÆ°ÁêÜ\n */\n\nimport aisiriService from './aiApi.js'\nimport { MESSAGE_TYPES, SENDERS } from '../types/index.js'\n\n/**\n * ÁîüÊàêÂîØ‰∏ÄÊ∂àÊÅØID\n */\nfunction generateMessageId() {\n  return `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\n}\n\n/**\n * ÂàõÂª∫Ê∂àÊÅØÂØπË±°\n */\nfunction createMessage(content, sender = SENDERS.AI, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n  return {\n    id: generateMessageId(),\n    content,\n    sender,\n    type,\n    timestamp: new Date(),\n    metadata,\n    isUser: sender === SENDERS.USER\n  }\n}\n\n/**\n * Ê∂àÊÅØÊúçÂä°Á±ª\n */\nclass MessageService {\n  constructor() {\n    this.messages = []\n    this.isProcessing = false\n    this.currentSessionId = null\n    this.historyLoaded = false\n    this.initialized = false\n    \n    console.log('üí¨ AIsiriÊô∫ËÉΩË∞ÉÂ∫¶Ê∂àÊÅØÊúçÂä°ÂàùÂßãÂåñÂÆåÊàê')\n  }\n\n  /**\n   * ÂàùÂßãÂåñÊúçÂä°Ôºà‰ªÖÂú®È¶ñÊ¨°‰ΩøÁî®Êó∂Ë∞ÉÁî®Ôºâ\n   */\n  async initialize() {\n    if (this.initialized) {\n      console.log('üìã MessageServiceÂ∑≤ÂàùÂßãÂåñÔºåË∑≥ËøáÈáçÂ§çÂàùÂßãÂåñ')\n      return\n    }\n    \n    console.log('üöÄ ÂºÄÂßãÂàùÂßãÂåñMessageService')\n    this.initialized = true\n  }\n\n  /**\n   * Ê∑ªÂä†Ê¨¢ËøéÊ∂àÊÅØ\n   */\n  addWelcomeMessage() {\n    const welcomeMessage = createMessage(\n      '‰Ω†Â•ΩÔºÅÊàëÊòØ‰Ω†ÁöÑAIÊô∫ËÉΩÂä©Êâã„ÄÇÊàëÂèØ‰ª•Â∏ÆÂä©‰Ω†ÂàõÂª∫‰ªªÂä°„ÄÅÂÆâÊéíÊó•Á®ã„ÄÅÊèê‰æõÊÉÖÁª™ÊîØÊåÅÔºå‰ª•ÂèäË∞ÉÁî®ÂêÑÁßçÂ§ñÈÉ®Â∑•ÂÖ∑„ÄÇËØ∑ÂëäËØâÊàë‰Ω†ÈúÄË¶Å‰ªÄ‰πàÂ∏ÆÂä©Ôºü',\n      SENDERS.AI,\n      MESSAGE_TYPES.TEXT\n    )\n    this.messages.push(welcomeMessage)\n  }\n\n  /**\n   * ‰ªéÂêéÁ´ØÂä†ËΩΩËÅäÂ§©ÂéÜÂè≤\n   */\n  async loadChatHistory(sessionId = null) {\n    try {\n      console.log('üìö ÂºÄÂßãÂä†ËΩΩËÅäÂ§©ÂéÜÂè≤', { sessionId })\n      \n      // Ëé∑Âèñtoken\n      const token = localStorage.getItem('token')\n      if (!token) {\n        console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞ËÆ§ËØÅtokenÔºåË∑≥ËøáÂéÜÂè≤Âä†ËΩΩ')\n        this.addWelcomeMessage()\n        this.historyLoaded = true\n        return\n      }\n\n      // ÊûÑÂª∫APIËØ∑Ê±Ç\n      const url = sessionId \n        ? `/api/ai/conversation/history?sessionId=${sessionId}&limit=50`\n        : '/api/ai/conversation/history?limit=50'\n      \n      const response = await fetch(url, {\n        method: 'GET',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n          'Content-Type': 'application/json'\n        }\n      })\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`)\n      }\n\n      const data = await response.json()\n      \n      if (data.success && data.data && data.data.conversations) {\n        const conversations = data.data.conversations\n        console.log(`üì• ÊàêÂäüÂä†ËΩΩ ${conversations.length} Êù°ËÅäÂ§©ËÆ∞ÂΩï`)\n        \n        // Ê∏ÖÁ©∫Áé∞ÊúâÊ∂àÊÅØ\n        this.messages = []\n        \n        // ËΩ¨Êç¢ÂêéÁ´ØÊï∞ÊçÆ‰∏∫ÂâçÁ´ØÊ∂àÊÅØÊ†ºÂºè\n        conversations.forEach(conv => {\n          const message = createMessage(\n            conv.content,\n            conv.messageType === 'user' ? SENDERS.USER : SENDERS.AI,\n            MESSAGE_TYPES.TEXT,\n            {\n              timestamp: new Date(conv.createdAt),\n              intent: conv.intent,\n              confidence: conv.intentConfidence,\n              sessionId: conv.sessionId\n            }\n          )\n          // ‰ΩøÁî®ÂéüÂßãÊó∂Èó¥Êà≥\n          message.timestamp = new Date(conv.createdAt)\n          this.messages.push(message)\n        })\n        \n        // ÊåâÊó∂Èó¥Êà≥ÊéíÂ∫èÊ∂àÊÅØÔºåÁ°Æ‰øùËÅäÂ§©ËÆ∞ÂΩïÊåâÊ≠£Á°ÆÈ°∫Â∫èÊòæÁ§∫\n        this.messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))\n        \n        // Â¶ÇÊûúÊ≤°ÊúâÂéÜÂè≤ËÆ∞ÂΩïÔºåÊ∑ªÂä†Ê¨¢ËøéÊ∂àÊÅØ\n        if (conversations.length === 0) {\n          this.addWelcomeMessage()\n        }\n        \n        // ËÆæÁΩÆÂΩìÂâç‰ºöËØùID\n        if (conversations.length > 0) {\n          this.currentSessionId = conversations[0].sessionId\n        }\n        \n      } else {\n        console.warn('‚ö†Ô∏è ÂêéÁ´ØËøîÂõûÊï∞ÊçÆÊ†ºÂºèÂºÇÂ∏∏', data)\n        this.addWelcomeMessage()\n      }\n      \n      this.historyLoaded = true\n      console.log('‚úÖ ËÅäÂ§©ÂéÜÂè≤Âä†ËΩΩÂÆåÊàê')\n      \n    } catch (error) {\n      console.error('‚ùå Âä†ËΩΩËÅäÂ§©ÂéÜÂè≤Â§±Ë¥•:', error)\n      // Âä†ËΩΩÂ§±Ë¥•Êó∂ÊòæÁ§∫Ê¨¢ËøéÊ∂àÊÅØ\n      this.messages = []\n      this.addWelcomeMessage()\n      this.historyLoaded = true\n    }\n  }\n\n  /**\n   * Ê£ÄÊü•ÊòØÂê¶Â∑≤Âä†ËΩΩÂéÜÂè≤ËÆ∞ÂΩï\n   */\n  isHistoryLoaded() {\n    return this.historyLoaded\n  }\n\n  /**\n   * Ëé∑ÂèñÊâÄÊúâÊ∂àÊÅØ\n   */\n  getMessages() {\n    return [...this.messages]\n  }\n\n  /**\n   * Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ\n   */\n  async addUserMessage(content, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n    // Ê£ÄÊü•ÊòØÂê¶ÊòØÂõæÁâáÊ∂àÊÅØ\n    let messageType = type\n    if (content && content.startsWith('üñºÔ∏è ÂõæÁâáÔºö')) {\n      messageType = 'IMAGE' // ‰ΩøÁî®Ëá™ÂÆö‰πâÂõæÁâáÁ±ªÂûã\n    }\n    \n    const message = createMessage(content, SENDERS.USER, messageType, metadata)\n    this.messages.push(message)\n    \n    console.log(`üìù Áî®Êà∑Ê∂àÊÅØ: ${content}`)\n    \n    // ‰øùÂ≠òÁî®Êà∑Ê∂àÊÅØÂà∞ÂêéÁ´ØÊï∞ÊçÆÂ∫ì\n    try {\n      await this.saveMessageToBackend(message, 'user')\n    } catch (error) {\n      console.error('‚ùå ‰øùÂ≠òÁî®Êà∑Ê∂àÊÅØÂà∞ÂêéÁ´ØÂ§±Ë¥•:', error)\n      // ‰∏çÂΩ±ÂìçÂâçÁ´ØÊòæÁ§∫ÔºåÂè™ËÆ∞ÂΩïÈîôËØØ\n    }\n    \n    return message\n  }\n\n  /**\n   * ‰øùÂ≠òÊ∂àÊÅØÂà∞ÂêéÁ´ØÊï∞ÊçÆÂ∫ì\n   */\n  async saveMessageToBackend(message, messageType) {\n    try {\n      const token = localStorage.getItem('token')\n      if (!token) {\n        console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞ËÆ§ËØÅtokenÔºåË∑≥ËøáÊ∂àÊÅØ‰øùÂ≠ò')\n        return\n      }\n\n      const response = await fetch('/api/ai/conversation/save', {\n        method: 'POST',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n          'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({\n          content: message.content,\n          messageType: messageType,\n          sessionId: this.currentSessionId || this.createNewSession(),\n          intent: message.metadata?.intent,\n          intentConfidence: message.metadata?.confidence,\n          timestamp: message.timestamp\n        })\n      })\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`)\n      }\n\n      const data = await response.json()\n      if (data.success) {\n        console.log(`üíæ Ê∂àÊÅØÂ∑≤‰øùÂ≠òÂà∞ÂêéÁ´Ø: ${messageType}`)\n      } else {\n        throw new Error(data.message || '‰øùÂ≠òÂ§±Ë¥•')\n      }\n    } catch (error) {\n      console.error('‚ùå ‰øùÂ≠òÊ∂àÊÅØÂà∞ÂêéÁ´ØÂ§±Ë¥•:', error)\n      throw error\n    }\n  }\n\n  /**\n   * Ê∑ªÂä†AIÊ∂àÊÅØ\n   */\n  async addAIMessage(content, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n    const message = createMessage(content, SENDERS.AI, type, metadata)\n    this.messages.push(message)\n    \n    console.log(`ü§ñ AIÂõûÂ§ç: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`)\n    \n    // ‰øùÂ≠òAIÊ∂àÊÅØÂà∞ÂêéÁ´ØÊï∞ÊçÆÂ∫ì\n    try {\n      await this.saveMessageToBackend(message, 'ai')\n    } catch (error) {\n      console.error('‚ùå ‰øùÂ≠òAIÊ∂àÊÅØÂà∞ÂêéÁ´ØÂ§±Ë¥•:', error)\n      // ‰∏çÂΩ±ÂìçÂâçÁ´ØÊòæÁ§∫ÔºåÂè™ËÆ∞ÂΩïÈîôËØØ\n    }\n    \n    return message\n  }\n\n  /**\n   * Ê∑ªÂä†AIÂõûÂ§çÔºà‰∏çËß¶ÂèëÊô∫ËÉΩË∞ÉÂ∫¶Ôºâ\n   */\n  addAIReply(content, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n    const message = createMessage(content, SENDERS.AI, type, metadata)\n    this.messages.push(message)\n    \n    console.log(`ü§ñ AIÁõ¥Êé•ÂõûÂ§ç: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`)\n    return message\n  }\n\n  /**\n   * Ê∑ªÂä†ËØ≠Èü≥Ê∂àÊÅØ\n   */\n  addVoiceMessage(voiceData, isUser = false) {\n    const message = {\n      id: Date.now() + Math.random(),\n      type: MESSAGE_TYPES.VOICE,\n      isUser: isUser,\n      timestamp: new Date(),\n      duration: voiceData.transcription ? Math.ceil(voiceData.transcription.length / 5) : 3, // Ê†πÊçÆÊñáÂ≠óÈïøÂ∫¶‰º∞ÁÆóÊó∂Èïø\n      transcription: voiceData.transcription || '',\n      audioUrl: voiceData.audioUrl || '',\n      audioFile: voiceData.audioFile || null\n    }\n    \n    this.messages.push(message)\n    console.log(`üé§ ${isUser ? 'Áî®Êà∑' : 'AI'}ËØ≠Èü≥Ê∂àÊÅØÂ∑≤Ê∑ªÂä†: ${voiceData.transcription?.substring(0, 50) || 'Êó†ÊñáÂ≠ó'}...`)\n    \n    return message\n  }\n\n  /**\n   * Ê∑ªÂä†Á≥ªÁªüÊ∂àÊÅØ\n   */\n  addSystemMessage(content) {\n    const message = createMessage(content, SENDERS.SYSTEM, MESSAGE_TYPES.TEXT)\n    this.messages.push(message)\n    \n    console.log(`‚öôÔ∏è  Á≥ªÁªüÊ∂àÊÅØ: ${content}`)\n    return message\n  }\n\n  /**\n   * Â§ÑÁêÜÁî®Êà∑ËæìÂÖ•ÁöÑ‰∏ªË¶ÅÊñπÊ≥ï - ‰ΩøÁî®Êô∫ËÉΩË∞ÉÂ∫¶Á≥ªÁªü\n   */\n  async processUserInput(userInput) {\n    if (this.isProcessing) {\n      console.log('‚è≥ Ê≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåËØ∑Á®çÁ≠â...')\n      return\n    }\n\n    try {\n      this.isProcessing = true\n      \n      // 1. Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ\n      this.addUserMessage(userInput)\n      \n      // 2. Ë∞ÉÁî®AIsiriÊô∫ËÉΩË∞ÉÂ∫¶\n      console.log('\\nüöÄ ÂºÄÂßãÊô∫ËÉΩË∞ÉÂ∫¶Â§ÑÁêÜ...')\n      const response = await aisiriService.dispatch(userInput, this.currentSessionId)\n      \n      // 3. Â§ÑÁêÜÊô∫ËÉΩË∞ÉÂ∫¶ÂìçÂ∫î\n      await this.handleDispatchResponse(response)\n      \n    } catch (error) {\n      console.error('‚ùå Êô∫ËÉΩË∞ÉÂ∫¶Â§ÑÁêÜÂ§±Ë¥•:', error)\n      this.addAIMessage(\n        'Êä±Ê≠âÔºåÊàëÈÅáÂà∞‰∫Ü‰∏Ä‰∫õÊäÄÊúØÈóÆÈ¢ò„ÄÇËØ∑Á®çÂêéÂÜçËØïÔºåÊàñËÄÖÂ∞ùËØïÈáçÊñ∞ÊèèËø∞‰Ω†ÁöÑÈúÄÊ±Ç„ÄÇ',\n        MESSAGE_TYPES.ERROR,\n        { error: error.message }\n      )\n    } finally {\n      this.isProcessing = false\n    }\n  }\n\n  /**\n   * Â§ÑÁêÜÁî®Êà∑ËØ≠Èü≥ËæìÂÖ• - ËøîÂõûËØ≠Èü≥ÂõûÂ§ç\n   */\n  async processVoiceInput(voiceData) {\n    if (this.isProcessing) {\n      console.log('‚è≥ Ê≠£Âú®Â§ÑÁêÜ‰∏≠ÔºåËØ∑Á®çÁ≠â...')\n      return\n    }\n\n    try {\n      this.isProcessing = true\n      \n      // 1. Ê∑ªÂä†Áî®Êà∑ËØ≠Èü≥Ê∂àÊÅØ\n      this.addVoiceMessage(voiceData, true) // trueË°®Á§∫ÊòØÁî®Êà∑Ê∂àÊÅØ\n      \n      // 2. Ë∞ÉÁî®AIsiriÊô∫ËÉΩË∞ÉÂ∫¶\n      console.log('\\nüöÄ ÂºÄÂßãÊô∫ËÉΩË∞ÉÂ∫¶Â§ÑÁêÜËØ≠Èü≥ËæìÂÖ•...')\n      const response = await aisiriService.dispatch(voiceData.transcription, this.currentSessionId)\n      \n      // 3. Â§ÑÁêÜÊô∫ËÉΩË∞ÉÂ∫¶ÂìçÂ∫îÔºåÁîüÊàêËØ≠Èü≥ÂõûÂ§ç\n      await this.handleVoiceDispatchResponse(response, voiceData)\n      \n    } catch (error) {\n      console.error('‚ùå ËØ≠Èü≥Êô∫ËÉΩË∞ÉÂ∫¶Â§ÑÁêÜÂ§±Ë¥•:', error)\n      this.addVoiceMessage({\n        transcription: 'Êä±Ê≠âÔºåÊàëÈÅáÂà∞‰∫Ü‰∏Ä‰∫õÊäÄÊúØÈóÆÈ¢ò„ÄÇËØ∑Á®çÂêéÂÜçËØïÔºåÊàñËÄÖÂ∞ùËØïÈáçÊñ∞ÊèèËø∞‰Ω†ÁöÑÈúÄÊ±Ç„ÄÇ',\n        duration: 3,\n        isUser: false\n      }, false) // falseË°®Á§∫ÊòØAIÊ∂àÊÅØ\n    } finally {\n      this.isProcessing = false\n    }\n  }\n\n  /**\n   * Â§ÑÁêÜËØ≠Èü≥Êô∫ËÉΩË∞ÉÂ∫¶ÂìçÂ∫î - AIÂõûÂ§ç‰øùÊåÅÊñáÂ≠óÂΩ¢Âºè\n   */\n  async handleVoiceDispatchResponse(response, originalVoiceData) {\n    if (!response.success) {\n      // Â§ÑÁêÜÈîôËØØÂìçÂ∫î\n      const errorMessage = response.error || 'Êä±Ê≠âÔºåÁ≥ªÁªüÈÅáÂà∞‰∫ÜÈóÆÈ¢ò„ÄÇ'\n      this.addAIMessage(errorMessage, MESSAGE_TYPES.ERROR, { apiError: response.error })\n      return\n    }\n\n    const { data } = response\n    \n    // AIÂõûÂ§ç‰øùÊåÅÊñáÂ≠óÂΩ¢ÂºèÔºå‰∏çËΩ¨Êç¢‰∏∫ËØ≠Èü≥\n    this.addAIMessage(data.response, MESSAGE_TYPES.TEXT, {\n      intents: data.intents,\n      servicesExecuted: data.servicesExecuted,\n      taskCreated: data.taskCreated,\n      scheduleAdjusted: data.scheduleAdjusted,\n      emotionalSupport: data.emotionalSupport,\n      processingTime: response.processingTime,\n      isVoiceInput: true // Ê†áËÆ∞ËøôÊòØÊù•Ëá™ËØ≠Èü≥ËæìÂÖ•ÁöÑÂõûÂ§ç\n    })\n    \n    // Â¶ÇÊûúÊúâ‰ªªÂä°ÂàõÂª∫ÔºåÊ∑ªÂä†‰ªªÂä°ÂàõÂª∫Ê∂àÊÅØ\n    if (data.taskCreated) {\n      this.addTaskCreatedMessage(data.taskCreated)\n    }\n\n    // Â¶ÇÊûúÊúâÊó•Á®ãË∞ÉÊï¥ÔºåÊ∑ªÂä†Êó•Á®ãË∞ÉÊï¥Ê∂àÊÅØ\n    if (data.scheduleAdjusted) {\n      this.addScheduleAdjustedMessage(data.scheduleAdjusted)\n    }\n\n    // ÈÄöÁü•‰ªªÂä°È°µÂà∑Êñ∞ÔºàÂ¶ÇÊûúÊúâ‰ªªÂä°Áõ∏ÂÖ≥Êìç‰ΩúÔºâ\n    if (data.taskCreated || data.scheduleAdjusted) {\n      try {\n        window.dispatchEvent(new CustomEvent('ai-dispatch-completed', {\n          detail: {\n            taskCreated: data.taskCreated,\n            scheduleAdjusted: data.scheduleAdjusted,\n            intents: data.intents\n          }\n        }))\n      } catch (_) {\n        // noop: ÈÉ®ÂàÜÁéØÂ¢É‰∏ã window ‰∏çÂèØÁî®\n      }\n    }\n  }\n\n  /**\n   * Â§ÑÁêÜÊô∫ËÉΩË∞ÉÂ∫¶ÂìçÂ∫î\n   */\n  async handleDispatchResponse(response) {\n    if (!response.success) {\n      // Â§ÑÁêÜÈîôËØØÂìçÂ∫î\n      const errorMessage = response.error || 'Êä±Ê≠âÔºåÁ≥ªÁªüÈÅáÂà∞‰∫ÜÈóÆÈ¢ò„ÄÇ'\n      this.addAIMessage(errorMessage, MESSAGE_TYPES.ERROR, { apiError: response.error })\n      return\n    }\n\n    const { data } = response\n    \n    // Ê∑ªÂä†AIÂõûÂ§ç\n    this.addAIMessage(data.response, MESSAGE_TYPES.TEXT, {\n      intents: data.intents,\n      servicesExecuted: data.servicesExecuted,\n      taskCreated: data.taskCreated,\n      scheduleAdjusted: data.scheduleAdjusted,\n      emotionalSupport: data.emotionalSupport,\n      processingTime: response.processingTime\n    })\n\n    // Â¶ÇÊûúÊúâ‰ªªÂä°ÂàõÂª∫ÔºåÊ∑ªÂä†‰ªªÂä°ÂàõÂª∫Ê∂àÊÅØ\n    if (data.taskCreated) {\n      this.addTaskCreatedMessage(data.taskCreated)\n    }\n\n    // Â¶ÇÊûúÊúâÊó•Á®ãË∞ÉÊï¥ÔºåÊ∑ªÂä†Êó•Á®ãË∞ÉÊï¥Ê∂àÊÅØ\n    if (data.scheduleAdjusted) {\n      this.addScheduleAdjustedMessage(data.scheduleAdjusted)\n    }\n\n    // ÈÄöÁü•‰ªªÂä°È°µÂà∑Êñ∞ÔºàÂ¶ÇÊûúÊúâ‰ªªÂä°Áõ∏ÂÖ≥Êìç‰ΩúÔºâ\n    if (data.taskCreated || data.scheduleAdjusted) {\n      try {\n        window.dispatchEvent(new CustomEvent('ai-dispatch-completed', {\n          detail: {\n            taskCreated: data.taskCreated,\n            scheduleAdjusted: data.scheduleAdjusted,\n            intents: data.intents\n          }\n        }))\n      } catch (_) {\n        // noop: ÈÉ®ÂàÜÁéØÂ¢É‰∏ã window ‰∏çÂèØÁî®\n      }\n    }\n  }\n\n  /**\n   * Ê∑ªÂä†‰ªªÂä°ÂàõÂª∫ÊàêÂäüÊ∂àÊÅØ\n   */\n  addTaskCreatedMessage(task) {\n    let message = `‚úÖ ‰ªªÂä°Â∑≤ÂàõÂª∫Ôºö${task.title}`\n    if (task.scheduledTime) {\n      message += `ÔºåÂÆâÊéíÂú® ${task.date} ${task.scheduledTime}`\n    }\n    \n    this.addAIMessage(message, MESSAGE_TYPES.TASK_CREATED, {\n      task: task\n    })\n  }\n\n  /**\n   * Ê∑ªÂä†Êó•Á®ãË∞ÉÊï¥Ê∂àÊÅØ\n   */\n  addScheduleAdjustedMessage(scheduleInfo) {\n    const message = '‚è∞ Êó•Á®ãÂ∑≤Ê†πÊçÆ‰Ω†ÁöÑÈúÄÊ±ÇËøõË°åË∞ÉÊï¥'\n    \n    this.addAIMessage(message, MESSAGE_TYPES.SCHEDULE_ADJUSTED, {\n      scheduleInfo: scheduleInfo\n    })\n  }\n\n  /**\n   * Ê£ÄÊü•ÊòØÂê¶Ê≠£Âú®Â§ÑÁêÜ‰∏≠\n   */\n  isCurrentlyProcessing() {\n    return this.isProcessing\n  }\n\n  /**\n   * Ëé∑ÂèñÂΩìÂâç‰ºöËØùID\n   */\n  getCurrentSessionId() {\n    return this.currentSessionId\n  }\n\n  /**\n   * ËÆæÁΩÆ‰ºöËØùID\n   */\n  setSessionId(sessionId) {\n    this.currentSessionId = sessionId\n    console.log(`üîÑ ËÆæÁΩÆ‰ºöËØùID: ${sessionId}`)\n  }\n\n  /**\n   * ÂàõÂª∫Êñ∞‰ºöËØù\n   */\n  createNewSession() {\n    this.currentSessionId = aisiriService.createNewSession()\n    console.log(`üÜï ÂàõÂª∫Êñ∞‰ºöËØù: ${this.currentSessionId}`)\n    return this.currentSessionId\n  }\n\n  /**\n   * Ê∏ÖÈô§ÊâÄÊúâÊ∂àÊÅØ\n   */\n  clearMessages() {\n    this.messages = []\n    this.currentSessionId = null\n    this.addWelcomeMessage()\n    console.log('üßπ Ê∂àÊÅØÂéÜÂè≤Â∑≤Ê∏ÖÈô§')\n  }\n\n  /**\n   * ÂØºÂá∫Ê∂àÊÅØÂéÜÂè≤ÔºàÁî®‰∫éË∞ÉËØïÔºâ\n   */\n  exportMessages() {\n    return {\n      messages: this.getMessages(),\n      sessionId: this.currentSessionId,\n      timestamp: new Date().toISOString()\n    }\n  }\n}\n\n// ÂàõÂª∫Âçï‰æãÂÆû‰æã\nconst messageService = new MessageService()\n\nexport default messageService"],"mappings":";;;AAAA;AACA;AACA;AACA;;AAEA,OAAOA,aAAa,MAAM,YAAY;AACtC,SAASC,aAAa,EAAEC,OAAO,QAAQ,mBAAmB;;AAE1D;AACA;AACA;AACA,SAASC,iBAAiBA,CAAA,EAAG;EAC3B,OAAO,OAAOC,IAAI,CAACC,GAAG,CAAC,CAAC,IAAIC,IAAI,CAACC,MAAM,CAAC,CAAC,CAACC,QAAQ,CAAC,EAAE,CAAC,CAACC,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,EAAE;AACvE;;AAEA;AACA;AACA;AACA,SAASC,aAAaA,CAACC,OAAO,EAAEC,MAAM,GAAGV,OAAO,CAACW,EAAE,EAAEC,IAAI,GAAGb,aAAa,CAACc,IAAI,EAAEC,QAAQ,GAAG,CAAC,CAAC,EAAE;EAC7F,OAAO;IACLC,EAAE,EAAEd,iBAAiB,CAAC,CAAC;IACvBQ,OAAO;IACPC,MAAM;IACNE,IAAI;IACJI,SAAS,EAAE,IAAId,IAAI,CAAC,CAAC;IACrBY,QAAQ;IACRG,MAAM,EAAEP,MAAM,KAAKV,OAAO,CAACkB;EAC7B,CAAC;AACH;;AAEA;AACA;AACA;AACA,MAAMC,cAAc,CAAC;EACnBC,WAAWA,CAAA,EAAG;IACZ,IAAI,CAACC,QAAQ,GAAG,EAAE;IAClB,IAAI,CAACC,YAAY,GAAG,KAAK;IACzB,IAAI,CAACC,gBAAgB,GAAG,IAAI;IAC5B,IAAI,CAACC,aAAa,GAAG,KAAK;IAC1B,IAAI,CAACC,WAAW,GAAG,KAAK;IAExBC,OAAO,CAACC,GAAG,CAAC,wBAAwB,CAAC;EACvC;;EAEA;AACF;AACA;EACE,MAAMC,UAAUA,CAAA,EAAG;IACjB,IAAI,IAAI,CAACH,WAAW,EAAE;MACpBC,OAAO,CAACC,GAAG,CAAC,+BAA+B,CAAC;MAC5C;IACF;IAEAD,OAAO,CAACC,GAAG,CAAC,wBAAwB,CAAC;IACrC,IAAI,CAACF,WAAW,GAAG,IAAI;EACzB;;EAEA;AACF;AACA;EACEI,iBAAiBA,CAAA,EAAG;IAClB,MAAMC,cAAc,GAAGtB,aAAa,CAClC,8DAA8D,EAC9DR,OAAO,CAACW,EAAE,EACVZ,aAAa,CAACc,IAChB,CAAC;IACD,IAAI,CAACQ,QAAQ,CAACU,IAAI,CAACD,cAAc,CAAC;EACpC;;EAEA;AACF;AACA;EACE,MAAME,eAAeA,CAACC,SAAS,GAAG,IAAI,EAAE;IACtC,IAAI;MACFP,OAAO,CAACC,GAAG,CAAC,aAAa,EAAE;QAAEM;MAAU,CAAC,CAAC;;MAEzC;MACA,MAAMC,KAAK,GAAGC,YAAY,CAACC,OAAO,CAAC,OAAO,CAAC;MAC3C,IAAI,CAACF,KAAK,EAAE;QACVR,OAAO,CAACW,IAAI,CAAC,sBAAsB,CAAC;QACpC,IAAI,CAACR,iBAAiB,CAAC,CAAC;QACxB,IAAI,CAACL,aAAa,GAAG,IAAI;QACzB;MACF;;MAEA;MACA,MAAMc,GAAG,GAAGL,SAAS,GACjB,0CAA0CA,SAAS,WAAW,GAC9D,uCAAuC;MAE3C,MAAMM,QAAQ,GAAG,MAAMC,KAAK,CAACF,GAAG,EAAE;QAChCG,MAAM,EAAE,KAAK;QACbC,OAAO,EAAE;UACP,eAAe,EAAE,UAAUR,KAAK,EAAE;UAClC,cAAc,EAAE;QAClB;MACF,CAAC,CAAC;MAEF,IAAI,CAACK,QAAQ,CAACI,EAAE,EAAE;QAChB,MAAM,IAAIC,KAAK,CAAC,QAAQL,QAAQ,CAACM,MAAM,KAAKN,QAAQ,CAACO,UAAU,EAAE,CAAC;MACpE;MAEA,MAAMC,IAAI,GAAG,MAAMR,QAAQ,CAACS,IAAI,CAAC,CAAC;MAElC,IAAID,IAAI,CAACE,OAAO,IAAIF,IAAI,CAACA,IAAI,IAAIA,IAAI,CAACA,IAAI,CAACG,aAAa,EAAE;QACxD,MAAMA,aAAa,GAAGH,IAAI,CAACA,IAAI,CAACG,aAAa;QAC7CxB,OAAO,CAACC,GAAG,CAAC,WAAWuB,aAAa,CAACC,MAAM,QAAQ,CAAC;;QAEpD;QACA,IAAI,CAAC9B,QAAQ,GAAG,EAAE;;QAElB;QACA6B,aAAa,CAACE,OAAO,CAACC,IAAI,IAAI;UAC5B,MAAMC,OAAO,GAAG9C,aAAa,CAC3B6C,IAAI,CAAC5C,OAAO,EACZ4C,IAAI,CAACE,WAAW,KAAK,MAAM,GAAGvD,OAAO,CAACkB,IAAI,GAAGlB,OAAO,CAACW,EAAE,EACvDZ,aAAa,CAACc,IAAI,EAClB;YACEG,SAAS,EAAE,IAAId,IAAI,CAACmD,IAAI,CAACG,SAAS,CAAC;YACnCC,MAAM,EAAEJ,IAAI,CAACI,MAAM;YACnBC,UAAU,EAAEL,IAAI,CAACM,gBAAgB;YACjC1B,SAAS,EAAEoB,IAAI,CAACpB;UAClB,CACF,CAAC;UACD;UACAqB,OAAO,CAACtC,SAAS,GAAG,IAAId,IAAI,CAACmD,IAAI,CAACG,SAAS,CAAC;UAC5C,IAAI,CAACnC,QAAQ,CAACU,IAAI,CAACuB,OAAO,CAAC;QAC7B,CAAC,CAAC;;QAEF;QACA,IAAI,CAACjC,QAAQ,CAACuC,IAAI,CAAC,CAACC,CAAC,EAAEC,CAAC,KAAK,IAAI5D,IAAI,CAAC2D,CAAC,CAAC7C,SAAS,CAAC,GAAG,IAAId,IAAI,CAAC4D,CAAC,CAAC9C,SAAS,CAAC,CAAC;;QAE3E;QACA,IAAIkC,aAAa,CAACC,MAAM,KAAK,CAAC,EAAE;UAC9B,IAAI,CAACtB,iBAAiB,CAAC,CAAC;QAC1B;;QAEA;QACA,IAAIqB,aAAa,CAACC,MAAM,GAAG,CAAC,EAAE;UAC5B,IAAI,CAAC5B,gBAAgB,GAAG2B,aAAa,CAAC,CAAC,CAAC,CAACjB,SAAS;QACpD;MAEF,CAAC,MAAM;QACLP,OAAO,CAACW,IAAI,CAAC,eAAe,EAAEU,IAAI,CAAC;QACnC,IAAI,CAAClB,iBAAiB,CAAC,CAAC;MAC1B;MAEA,IAAI,CAACL,aAAa,GAAG,IAAI;MACzBE,OAAO,CAACC,GAAG,CAAC,YAAY,CAAC;IAE3B,CAAC,CAAC,OAAOoC,KAAK,EAAE;MACdrC,OAAO,CAACqC,KAAK,CAAC,aAAa,EAAEA,KAAK,CAAC;MACnC;MACA,IAAI,CAAC1C,QAAQ,GAAG,EAAE;MAClB,IAAI,CAACQ,iBAAiB,CAAC,CAAC;MACxB,IAAI,CAACL,aAAa,GAAG,IAAI;IAC3B;EACF;;EAEA;AACF;AACA;EACEwC,eAAeA,CAAA,EAAG;IAChB,OAAO,IAAI,CAACxC,aAAa;EAC3B;;EAEA;AACF;AACA;EACEyC,WAAWA,CAAA,EAAG;IACZ,OAAO,CAAC,GAAG,IAAI,CAAC5C,QAAQ,CAAC;EAC3B;;EAEA;AACF;AACA;EACE,MAAM6C,cAAcA,CAACzD,OAAO,EAAEG,IAAI,GAAGb,aAAa,CAACc,IAAI,EAAEC,QAAQ,GAAG,CAAC,CAAC,EAAE;IACtE;IACA,IAAIyC,WAAW,GAAG3C,IAAI;IACtB,IAAIH,OAAO,IAAIA,OAAO,CAAC0D,UAAU,CAAC,SAAS,CAAC,EAAE;MAC5CZ,WAAW,GAAG,OAAO,EAAC;IACxB;IAEA,MAAMD,OAAO,GAAG9C,aAAa,CAACC,OAAO,EAAET,OAAO,CAACkB,IAAI,EAAEqC,WAAW,EAAEzC,QAAQ,CAAC;IAC3E,IAAI,CAACO,QAAQ,CAACU,IAAI,CAACuB,OAAO,CAAC;IAE3B5B,OAAO,CAACC,GAAG,CAAC,YAAYlB,OAAO,EAAE,CAAC;;IAElC;IACA,IAAI;MACF,MAAM,IAAI,CAAC2D,oBAAoB,CAACd,OAAO,EAAE,MAAM,CAAC;IAClD,CAAC,CAAC,OAAOS,KAAK,EAAE;MACdrC,OAAO,CAACqC,KAAK,CAAC,gBAAgB,EAAEA,KAAK,CAAC;MACtC;IACF;IAEA,OAAOT,OAAO;EAChB;;EAEA;AACF;AACA;EACE,MAAMc,oBAAoBA,CAACd,OAAO,EAAEC,WAAW,EAAE;IAC/C,IAAI;MACF,MAAMrB,KAAK,GAAGC,YAAY,CAACC,OAAO,CAAC,OAAO,CAAC;MAC3C,IAAI,CAACF,KAAK,EAAE;QACVR,OAAO,CAACW,IAAI,CAAC,sBAAsB,CAAC;QACpC;MACF;MAEA,MAAME,QAAQ,GAAG,MAAMC,KAAK,CAAC,2BAA2B,EAAE;QACxDC,MAAM,EAAE,MAAM;QACdC,OAAO,EAAE;UACP,eAAe,EAAE,UAAUR,KAAK,EAAE;UAClC,cAAc,EAAE;QAClB,CAAC;QACDmC,IAAI,EAAEC,IAAI,CAACC,SAAS,CAAC;UACnB9D,OAAO,EAAE6C,OAAO,CAAC7C,OAAO;UACxB8C,WAAW,EAAEA,WAAW;UACxBtB,SAAS,EAAE,IAAI,CAACV,gBAAgB,IAAI,IAAI,CAACiD,gBAAgB,CAAC,CAAC;UAC3Df,MAAM,EAAEH,OAAO,CAACxC,QAAQ,EAAE2C,MAAM;UAChCE,gBAAgB,EAAEL,OAAO,CAACxC,QAAQ,EAAE4C,UAAU;UAC9C1C,SAAS,EAAEsC,OAAO,CAACtC;QACrB,CAAC;MACH,CAAC,CAAC;MAEF,IAAI,CAACuB,QAAQ,CAACI,EAAE,EAAE;QAChB,MAAM,IAAIC,KAAK,CAAC,QAAQL,QAAQ,CAACM,MAAM,KAAKN,QAAQ,CAACO,UAAU,EAAE,CAAC;MACpE;MAEA,MAAMC,IAAI,GAAG,MAAMR,QAAQ,CAACS,IAAI,CAAC,CAAC;MAClC,IAAID,IAAI,CAACE,OAAO,EAAE;QAChBvB,OAAO,CAACC,GAAG,CAAC,gBAAgB4B,WAAW,EAAE,CAAC;MAC5C,CAAC,MAAM;QACL,MAAM,IAAIX,KAAK,CAACG,IAAI,CAACO,OAAO,IAAI,MAAM,CAAC;MACzC;IACF,CAAC,CAAC,OAAOS,KAAK,EAAE;MACdrC,OAAO,CAACqC,KAAK,CAAC,cAAc,EAAEA,KAAK,CAAC;MACpC,MAAMA,KAAK;IACb;EACF;;EAEA;AACF;AACA;EACE,MAAMU,YAAYA,CAAChE,OAAO,EAAEG,IAAI,GAAGb,aAAa,CAACc,IAAI,EAAEC,QAAQ,GAAG,CAAC,CAAC,EAAE;IACpE,MAAMwC,OAAO,GAAG9C,aAAa,CAACC,OAAO,EAAET,OAAO,CAACW,EAAE,EAAEC,IAAI,EAAEE,QAAQ,CAAC;IAClE,IAAI,CAACO,QAAQ,CAACU,IAAI,CAACuB,OAAO,CAAC;IAE3B5B,OAAO,CAACC,GAAG,CAAC,YAAYlB,OAAO,CAACiE,SAAS,CAAC,CAAC,EAAE,EAAE,CAAC,GAAGjE,OAAO,CAAC0C,MAAM,GAAG,EAAE,GAAG,KAAK,GAAG,EAAE,EAAE,CAAC;;IAEtF;IACA,IAAI;MACF,MAAM,IAAI,CAACiB,oBAAoB,CAACd,OAAO,EAAE,IAAI,CAAC;IAChD,CAAC,CAAC,OAAOS,KAAK,EAAE;MACdrC,OAAO,CAACqC,KAAK,CAAC,gBAAgB,EAAEA,KAAK,CAAC;MACtC;IACF;IAEA,OAAOT,OAAO;EAChB;;EAEA;AACF;AACA;EACEqB,UAAUA,CAAClE,OAAO,EAAEG,IAAI,GAAGb,aAAa,CAACc,IAAI,EAAEC,QAAQ,GAAG,CAAC,CAAC,EAAE;IAC5D,MAAMwC,OAAO,GAAG9C,aAAa,CAACC,OAAO,EAAET,OAAO,CAACW,EAAE,EAAEC,IAAI,EAAEE,QAAQ,CAAC;IAClE,IAAI,CAACO,QAAQ,CAACU,IAAI,CAACuB,OAAO,CAAC;IAE3B5B,OAAO,CAACC,GAAG,CAAC,cAAclB,OAAO,CAACiE,SAAS,CAAC,CAAC,EAAE,EAAE,CAAC,GAAGjE,OAAO,CAAC0C,MAAM,GAAG,EAAE,GAAG,KAAK,GAAG,EAAE,EAAE,CAAC;IACxF,OAAOG,OAAO;EAChB;;EAEA;AACF;AACA;EACEsB,eAAeA,CAACC,SAAS,EAAE5D,MAAM,GAAG,KAAK,EAAE;IACzC,MAAMqC,OAAO,GAAG;MACdvC,EAAE,EAAEb,IAAI,CAACC,GAAG,CAAC,CAAC,GAAGC,IAAI,CAACC,MAAM,CAAC,CAAC;MAC9BO,IAAI,EAAEb,aAAa,CAAC+E,KAAK;MACzB7D,MAAM,EAAEA,MAAM;MACdD,SAAS,EAAE,IAAId,IAAI,CAAC,CAAC;MACrB6E,QAAQ,EAAEF,SAAS,CAACG,aAAa,GAAG5E,IAAI,CAAC6E,IAAI,CAACJ,SAAS,CAACG,aAAa,CAAC7B,MAAM,GAAG,CAAC,CAAC,GAAG,CAAC;MAAE;MACvF6B,aAAa,EAAEH,SAAS,CAACG,aAAa,IAAI,EAAE;MAC5CE,QAAQ,EAAEL,SAAS,CAACK,QAAQ,IAAI,EAAE;MAClCC,SAAS,EAAEN,SAAS,CAACM,SAAS,IAAI;IACpC,CAAC;IAED,IAAI,CAAC9D,QAAQ,CAACU,IAAI,CAACuB,OAAO,CAAC;IAC3B5B,OAAO,CAACC,GAAG,CAAC,MAAMV,MAAM,GAAG,IAAI,GAAG,IAAI,YAAY4D,SAAS,CAACG,aAAa,EAAEN,SAAS,CAAC,CAAC,EAAE,EAAE,CAAC,IAAI,KAAK,KAAK,CAAC;IAE1G,OAAOpB,OAAO;EAChB;;EAEA;AACF;AACA;EACE8B,gBAAgBA,CAAC3E,OAAO,EAAE;IACxB,MAAM6C,OAAO,GAAG9C,aAAa,CAACC,OAAO,EAAET,OAAO,CAACqF,MAAM,EAAEtF,aAAa,CAACc,IAAI,CAAC;IAC1E,IAAI,CAACQ,QAAQ,CAACU,IAAI,CAACuB,OAAO,CAAC;IAE3B5B,OAAO,CAACC,GAAG,CAAC,aAAalB,OAAO,EAAE,CAAC;IACnC,OAAO6C,OAAO;EAChB;;EAEA;AACF;AACA;EACE,MAAMgC,gBAAgBA,CAACC,SAAS,EAAE;IAChC,IAAI,IAAI,CAACjE,YAAY,EAAE;MACrBI,OAAO,CAACC,GAAG,CAAC,gBAAgB,CAAC;MAC7B;IACF;IAEA,IAAI;MACF,IAAI,CAACL,YAAY,GAAG,IAAI;;MAExB;MACA,IAAI,CAAC4C,cAAc,CAACqB,SAAS,CAAC;;MAE9B;MACA7D,OAAO,CAACC,GAAG,CAAC,kBAAkB,CAAC;MAC/B,MAAMY,QAAQ,GAAG,MAAMzC,aAAa,CAAC0F,QAAQ,CAACD,SAAS,EAAE,IAAI,CAAChE,gBAAgB,CAAC;;MAE/E;MACA,MAAM,IAAI,CAACkE,sBAAsB,CAAClD,QAAQ,CAAC;IAE7C,CAAC,CAAC,OAAOwB,KAAK,EAAE;MACdrC,OAAO,CAACqC,KAAK,CAAC,aAAa,EAAEA,KAAK,CAAC;MACnC,IAAI,CAACU,YAAY,CACf,mCAAmC,EACnC1E,aAAa,CAAC2F,KAAK,EACnB;QAAE3B,KAAK,EAAEA,KAAK,CAACT;MAAQ,CACzB,CAAC;IACH,CAAC,SAAS;MACR,IAAI,CAAChC,YAAY,GAAG,KAAK;IAC3B;EACF;;EAEA;AACF;AACA;EACE,MAAMqE,iBAAiBA,CAACd,SAAS,EAAE;IACjC,IAAI,IAAI,CAACvD,YAAY,EAAE;MACrBI,OAAO,CAACC,GAAG,CAAC,gBAAgB,CAAC;MAC7B;IACF;IAEA,IAAI;MACF,IAAI,CAACL,YAAY,GAAG,IAAI;;MAExB;MACA,IAAI,CAACsD,eAAe,CAACC,SAAS,EAAE,IAAI,CAAC,EAAC;;MAEtC;MACAnD,OAAO,CAACC,GAAG,CAAC,sBAAsB,CAAC;MACnC,MAAMY,QAAQ,GAAG,MAAMzC,aAAa,CAAC0F,QAAQ,CAACX,SAAS,CAACG,aAAa,EAAE,IAAI,CAACzD,gBAAgB,CAAC;;MAE7F;MACA,MAAM,IAAI,CAACqE,2BAA2B,CAACrD,QAAQ,EAAEsC,SAAS,CAAC;IAE7D,CAAC,CAAC,OAAOd,KAAK,EAAE;MACdrC,OAAO,CAACqC,KAAK,CAAC,eAAe,EAAEA,KAAK,CAAC;MACrC,IAAI,CAACa,eAAe,CAAC;QACnBI,aAAa,EAAE,mCAAmC;QAClDD,QAAQ,EAAE,CAAC;QACX9D,MAAM,EAAE;MACV,CAAC,EAAE,KAAK,CAAC,EAAC;IACZ,CAAC,SAAS;MACR,IAAI,CAACK,YAAY,GAAG,KAAK;IAC3B;EACF;;EAEA;AACF;AACA;EACE,MAAMsE,2BAA2BA,CAACrD,QAAQ,EAAEsD,iBAAiB,EAAE;IAC7D,IAAI,CAACtD,QAAQ,CAACU,OAAO,EAAE;MACrB;MACA,MAAM6C,YAAY,GAAGvD,QAAQ,CAACwB,KAAK,IAAI,aAAa;MACpD,IAAI,CAACU,YAAY,CAACqB,YAAY,EAAE/F,aAAa,CAAC2F,KAAK,EAAE;QAAEK,QAAQ,EAAExD,QAAQ,CAACwB;MAAM,CAAC,CAAC;MAClF;IACF;IAEA,MAAM;MAAEhB;IAAK,CAAC,GAAGR,QAAQ;;IAEzB;IACA,IAAI,CAACkC,YAAY,CAAC1B,IAAI,CAACR,QAAQ,EAAExC,aAAa,CAACc,IAAI,EAAE;MACnDmF,OAAO,EAAEjD,IAAI,CAACiD,OAAO;MACrBC,gBAAgB,EAAElD,IAAI,CAACkD,gBAAgB;MACvCC,WAAW,EAAEnD,IAAI,CAACmD,WAAW;MAC7BC,gBAAgB,EAAEpD,IAAI,CAACoD,gBAAgB;MACvCC,gBAAgB,EAAErD,IAAI,CAACqD,gBAAgB;MACvCC,cAAc,EAAE9D,QAAQ,CAAC8D,cAAc;MACvCC,YAAY,EAAE,IAAI,CAAC;IACrB,CAAC,CAAC;;IAEF;IACA,IAAIvD,IAAI,CAACmD,WAAW,EAAE;MACpB,IAAI,CAACK,qBAAqB,CAACxD,IAAI,CAACmD,WAAW,CAAC;IAC9C;;IAEA;IACA,IAAInD,IAAI,CAACoD,gBAAgB,EAAE;MACzB,IAAI,CAACK,0BAA0B,CAACzD,IAAI,CAACoD,gBAAgB,CAAC;IACxD;;IAEA;IACA,IAAIpD,IAAI,CAACmD,WAAW,IAAInD,IAAI,CAACoD,gBAAgB,EAAE;MAC7C,IAAI;QACFM,MAAM,CAACC,aAAa,CAAC,IAAIC,WAAW,CAAC,uBAAuB,EAAE;UAC5DC,MAAM,EAAE;YACNV,WAAW,EAAEnD,IAAI,CAACmD,WAAW;YAC7BC,gBAAgB,EAAEpD,IAAI,CAACoD,gBAAgB;YACvCH,OAAO,EAAEjD,IAAI,CAACiD;UAChB;QACF,CAAC,CAAC,CAAC;MACL,CAAC,CAAC,OAAOa,CAAC,EAAE;QACV;MAAA;IAEJ;EACF;;EAEA;AACF;AACA;EACE,MAAMpB,sBAAsBA,CAAClD,QAAQ,EAAE;IACrC,IAAI,CAACA,QAAQ,CAACU,OAAO,EAAE;MACrB;MACA,MAAM6C,YAAY,GAAGvD,QAAQ,CAACwB,KAAK,IAAI,aAAa;MACpD,IAAI,CAACU,YAAY,CAACqB,YAAY,EAAE/F,aAAa,CAAC2F,KAAK,EAAE;QAAEK,QAAQ,EAAExD,QAAQ,CAACwB;MAAM,CAAC,CAAC;MAClF;IACF;IAEA,MAAM;MAAEhB;IAAK,CAAC,GAAGR,QAAQ;;IAEzB;IACA,IAAI,CAACkC,YAAY,CAAC1B,IAAI,CAACR,QAAQ,EAAExC,aAAa,CAACc,IAAI,EAAE;MACnDmF,OAAO,EAAEjD,IAAI,CAACiD,OAAO;MACrBC,gBAAgB,EAAElD,IAAI,CAACkD,gBAAgB;MACvCC,WAAW,EAAEnD,IAAI,CAACmD,WAAW;MAC7BC,gBAAgB,EAAEpD,IAAI,CAACoD,gBAAgB;MACvCC,gBAAgB,EAAErD,IAAI,CAACqD,gBAAgB;MACvCC,cAAc,EAAE9D,QAAQ,CAAC8D;IAC3B,CAAC,CAAC;;IAEF;IACA,IAAItD,IAAI,CAACmD,WAAW,EAAE;MACpB,IAAI,CAACK,qBAAqB,CAACxD,IAAI,CAACmD,WAAW,CAAC;IAC9C;;IAEA;IACA,IAAInD,IAAI,CAACoD,gBAAgB,EAAE;MACzB,IAAI,CAACK,0BAA0B,CAACzD,IAAI,CAACoD,gBAAgB,CAAC;IACxD;;IAEA;IACA,IAAIpD,IAAI,CAACmD,WAAW,IAAInD,IAAI,CAACoD,gBAAgB,EAAE;MAC7C,IAAI;QACFM,MAAM,CAACC,aAAa,CAAC,IAAIC,WAAW,CAAC,uBAAuB,EAAE;UAC5DC,MAAM,EAAE;YACNV,WAAW,EAAEnD,IAAI,CAACmD,WAAW;YAC7BC,gBAAgB,EAAEpD,IAAI,CAACoD,gBAAgB;YACvCH,OAAO,EAAEjD,IAAI,CAACiD;UAChB;QACF,CAAC,CAAC,CAAC;MACL,CAAC,CAAC,OAAOa,CAAC,EAAE;QACV;MAAA;IAEJ;EACF;;EAEA;AACF;AACA;EACEN,qBAAqBA,CAACO,IAAI,EAAE;IAC1B,IAAIxD,OAAO,GAAG,WAAWwD,IAAI,CAACC,KAAK,EAAE;IACrC,IAAID,IAAI,CAACE,aAAa,EAAE;MACtB1D,OAAO,IAAI,QAAQwD,IAAI,CAACG,IAAI,IAAIH,IAAI,CAACE,aAAa,EAAE;IACtD;IAEA,IAAI,CAACvC,YAAY,CAACnB,OAAO,EAAEvD,aAAa,CAACmH,YAAY,EAAE;MACrDJ,IAAI,EAAEA;IACR,CAAC,CAAC;EACJ;;EAEA;AACF;AACA;EACEN,0BAA0BA,CAACW,YAAY,EAAE;IACvC,MAAM7D,OAAO,GAAG,iBAAiB;IAEjC,IAAI,CAACmB,YAAY,CAACnB,OAAO,EAAEvD,aAAa,CAACqH,iBAAiB,EAAE;MAC1DD,YAAY,EAAEA;IAChB,CAAC,CAAC;EACJ;;EAEA;AACF;AACA;EACEE,qBAAqBA,CAAA,EAAG;IACtB,OAAO,IAAI,CAAC/F,YAAY;EAC1B;;EAEA;AACF;AACA;EACEgG,mBAAmBA,CAAA,EAAG;IACpB,OAAO,IAAI,CAAC/F,gBAAgB;EAC9B;;EAEA;AACF;AACA;EACEgG,YAAYA,CAACtF,SAAS,EAAE;IACtB,IAAI,CAACV,gBAAgB,GAAGU,SAAS;IACjCP,OAAO,CAACC,GAAG,CAAC,cAAcM,SAAS,EAAE,CAAC;EACxC;;EAEA;AACF;AACA;EACEuC,gBAAgBA,CAAA,EAAG;IACjB,IAAI,CAACjD,gBAAgB,GAAGzB,aAAa,CAAC0E,gBAAgB,CAAC,CAAC;IACxD9C,OAAO,CAACC,GAAG,CAAC,aAAa,IAAI,CAACJ,gBAAgB,EAAE,CAAC;IACjD,OAAO,IAAI,CAACA,gBAAgB;EAC9B;;EAEA;AACF;AACA;EACEiG,aAAaA,CAAA,EAAG;IACd,IAAI,CAACnG,QAAQ,GAAG,EAAE;IAClB,IAAI,CAACE,gBAAgB,GAAG,IAAI;IAC5B,IAAI,CAACM,iBAAiB,CAAC,CAAC;IACxBH,OAAO,CAACC,GAAG,CAAC,YAAY,CAAC;EAC3B;;EAEA;AACF;AACA;EACE8F,cAAcA,CAAA,EAAG;IACf,OAAO;MACLpG,QAAQ,EAAE,IAAI,CAAC4C,WAAW,CAAC,CAAC;MAC5BhC,SAAS,EAAE,IAAI,CAACV,gBAAgB;MAChCP,SAAS,EAAE,IAAId,IAAI,CAAC,CAAC,CAACwH,WAAW,CAAC;IACpC,CAAC;EACH;AACF;;AAEA;AACA,MAAMC,cAAc,GAAG,IAAIxG,cAAc,CAAC,CAAC;AAE3C,eAAewG,cAAc","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}