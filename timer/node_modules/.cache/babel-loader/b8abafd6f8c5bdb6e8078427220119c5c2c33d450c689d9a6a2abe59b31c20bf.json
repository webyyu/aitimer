{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.for-each.js\";\n/**\n * AIsiri 智能调度消息处理服务\n * 处理聊天消息的格式化、存储和状态管理\n */\n\nimport aisiriService from './aiApi.js';\nimport { MESSAGE_TYPES, SENDERS } from '../types/index.js';\nimport { getAiApiUrl } from '../../config/api.js';\n\n/**\n * 生成唯一消息ID\n */\nfunction generateMessageId() {\n  return `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;\n}\n\n/**\n * 创建消息对象\n */\nfunction createMessage(content, sender = SENDERS.AI, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n  return {\n    id: generateMessageId(),\n    content,\n    sender,\n    type,\n    timestamp: new Date(),\n    metadata,\n    isUser: sender === SENDERS.USER\n  };\n}\n\n/**\n * 消息服务类\n */\nclass MessageService {\n  constructor() {\n    this.messages = [];\n    this.isProcessing = false;\n    this.currentSessionId = null;\n    this.historyLoaded = false;\n    console.log('💬 AIsiri智能调度消息服务初始化完成');\n  }\n\n  /**\n   * 添加欢迎消息\n   */\n  addWelcomeMessage() {\n    const welcomeMessage = createMessage('你好！我是你的AI智能助手。我可以帮助你创建任务、安排日程、提供情绪支持，以及调用各种外部工具。请告诉我你需要什么帮助？', SENDERS.AI, MESSAGE_TYPES.TEXT);\n    this.messages.push(welcomeMessage);\n  }\n\n  /**\n   * 从后端加载历史聊天记录\n   */\n  async loadHistoryFromBackend() {\n    if (this.historyLoaded) {\n      console.log('📚 历史记录已加载，跳过重复加载');\n      return;\n    }\n    try {\n      console.log('📚 开始从后端加载历史聊天记录');\n      const token = localStorage.getItem('token');\n      if (!token) {\n        console.warn('⚠️ 未找到认证token，跳过历史记录加载');\n        this.addWelcomeMessage();\n        return;\n      }\n      const response = await fetch(getAiApiUrl('/conversation/history?limit=50'), {\n        method: 'GET',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n          'Content-Type': 'application/json'\n        }\n      });\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n      const result = await response.json();\n      if (result.success && result.data.conversations && result.data.conversations.length > 0) {\n        console.log(`📚 成功加载 ${result.data.conversations.length} 条历史记录`);\n\n        // 清空当前消息列表\n        this.messages = [];\n\n        // 转换后端数据格式为前端消息格式\n        // 后端返回的是降序排列（最新在前），需要反转为升序（最旧在前）\n        const sortedConversations = result.data.conversations.reverse();\n        sortedConversations.forEach(conversation => {\n          const message = {\n            id: conversation._id,\n            content: conversation.content,\n            sender: conversation.messageType === 'user' ? SENDERS.USER : SENDERS.AI,\n            type: MESSAGE_TYPES.TEXT,\n            timestamp: new Date(conversation.createdAt),\n            metadata: {\n              intent: conversation.intent,\n              sessionId: conversation.sessionId,\n              aiMetadata: conversation.aiMetadata\n            },\n            isUser: conversation.messageType === 'user'\n          };\n          this.messages.push(message);\n        });\n        this.historyLoaded = true;\n        console.log('✅ 历史聊天记录加载完成');\n      } else {\n        console.log('📚 没有找到历史记录，添加欢迎消息');\n        this.addWelcomeMessage();\n      }\n    } catch (error) {\n      console.error('❌ 加载历史聊天记录失败:', error);\n      // 加载失败时添加欢迎消息\n      if (this.messages.length === 0) {\n        this.addWelcomeMessage();\n      }\n    }\n  }\n\n  /**\n   * 获取所有消息\n   */\n  getMessages() {\n    return [...this.messages];\n  }\n\n  /**\n   * 添加用户消息\n   */\n  addUserMessage(content, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n    // 检查是否是图片消息\n    let messageType = type;\n    if (content && content.startsWith('🖼️ 图片：')) {\n      messageType = 'IMAGE'; // 使用自定义图片类型\n    }\n    const message = createMessage(content, SENDERS.USER, messageType, metadata);\n    this.messages.push(message);\n    console.log(`📝 用户消息: ${content}`);\n\n    // 保存用户消息到后端\n    this.saveMessageToBackend(content, 'user', metadata);\n    return message;\n  }\n\n  /**\n   * 添加AI消息\n   */\n  addAIMessage(content, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n    const message = createMessage(content, SENDERS.AI, type, metadata);\n    this.messages.push(message);\n    console.log(`🤖 AI回复: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`);\n\n    // 保存AI消息到后端\n    this.saveMessageToBackend(content, 'ai', metadata);\n    return message;\n  }\n\n  /**\n   * 添加AI回复（不触发智能调度）\n   */\n  addAIReply(content, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n    const message = createMessage(content, SENDERS.AI, type, metadata);\n    this.messages.push(message);\n    console.log(`🤖 AI直接回复: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`);\n    return message;\n  }\n\n  /**\n   * 添加语音消息\n   */\n  addVoiceMessage(voiceData, isUser = false) {\n    const message = {\n      id: Date.now() + Math.random(),\n      type: MESSAGE_TYPES.VOICE,\n      isUser: isUser,\n      timestamp: new Date(),\n      duration: voiceData.transcription ? Math.ceil(voiceData.transcription.length / 5) : 3,\n      // 根据文字长度估算时长\n      transcription: voiceData.transcription || '',\n      audioUrl: voiceData.audioUrl || '',\n      audioFile: voiceData.audioFile || null\n    };\n    this.messages.push(message);\n    console.log(`🎤 ${isUser ? '用户' : 'AI'}语音消息已添加: ${voiceData.transcription?.substring(0, 50) || '无文字'}...`);\n    return message;\n  }\n\n  /**\n   * 添加系统消息\n   */\n  addSystemMessage(content) {\n    const message = createMessage(content, SENDERS.SYSTEM, MESSAGE_TYPES.TEXT);\n    this.messages.push(message);\n    console.log(`⚙️  系统消息: ${content}`);\n    return message;\n  }\n\n  /**\n   * 处理用户输入的主要方法 - 使用智能调度系统\n   */\n  async processUserInput(userInput) {\n    if (this.isProcessing) {\n      console.log('⏳ 正在处理中，请稍等...');\n      return;\n    }\n    try {\n      this.isProcessing = true;\n\n      // 1. 添加用户消息\n      this.addUserMessage(userInput);\n\n      // 2. 调用AIsiri智能调度\n      console.log('\\n🚀 开始智能调度处理...');\n      const response = await aisiriService.dispatch(userInput, this.currentSessionId);\n\n      // 3. 处理智能调度响应\n      await this.handleDispatchResponse(response);\n    } catch (error) {\n      console.error('❌ 智能调度处理失败:', error);\n      this.addAIMessage('抱歉，我遇到了一些技术问题。请稍后再试，或者尝试重新描述你的需求。', MESSAGE_TYPES.ERROR, {\n        error: error.message\n      });\n    } finally {\n      this.isProcessing = false;\n    }\n  }\n\n  /**\n   * 处理用户语音输入 - 返回语音回复\n   */\n  async processVoiceInput(voiceData) {\n    if (this.isProcessing) {\n      console.log('⏳ 正在处理中，请稍等...');\n      return;\n    }\n    try {\n      this.isProcessing = true;\n\n      // 1. 添加用户语音消息\n      this.addVoiceMessage(voiceData, true); // true表示是用户消息\n\n      // 2. 调用AIsiri智能调度\n      console.log('\\n🚀 开始智能调度处理语音输入...');\n      const response = await aisiriService.dispatch(voiceData.transcription, this.currentSessionId);\n\n      // 3. 处理智能调度响应，生成语音回复\n      await this.handleVoiceDispatchResponse(response, voiceData);\n    } catch (error) {\n      console.error('❌ 语音智能调度处理失败:', error);\n      this.addVoiceMessage({\n        transcription: '抱歉，我遇到了一些技术问题。请稍后再试，或者尝试重新描述你的需求。',\n        duration: 3,\n        isUser: false\n      }, false); // false表示是AI消息\n    } finally {\n      this.isProcessing = false;\n    }\n  }\n\n  /**\n   * 处理语音智能调度响应 - AI回复保持文字形式\n   */\n  async handleVoiceDispatchResponse(response, originalVoiceData) {\n    if (!response.success) {\n      // 处理错误响应\n      const errorMessage = response.error || '抱歉，系统遇到了问题。';\n      this.addAIMessage(errorMessage, MESSAGE_TYPES.ERROR, {\n        apiError: response.error\n      });\n      return;\n    }\n    const {\n      data\n    } = response;\n\n    // AI回复保持文字形式，不转换为语音\n    this.addAIMessage(data.response, MESSAGE_TYPES.TEXT, {\n      intents: data.intents,\n      servicesExecuted: data.servicesExecuted,\n      taskCreated: data.taskCreated,\n      scheduleAdjusted: data.scheduleAdjusted,\n      emotionalSupport: data.emotionalSupport,\n      processingTime: response.processingTime,\n      isVoiceInput: true // 标记这是来自语音输入的回复\n    });\n\n    // 如果有任务创建，添加任务创建消息\n    if (data.taskCreated) {\n      this.addTaskCreatedMessage(data.taskCreated);\n    }\n\n    // 如果有日程调整，添加日程调整消息\n    if (data.scheduleAdjusted) {\n      this.addScheduleAdjustedMessage(data.scheduleAdjusted);\n    }\n\n    // 通知任务页刷新（如果有任务相关操作）\n    if (data.taskCreated || data.scheduleAdjusted) {\n      try {\n        window.dispatchEvent(new CustomEvent('ai-dispatch-completed', {\n          detail: {\n            taskCreated: data.taskCreated,\n            scheduleAdjusted: data.scheduleAdjusted,\n            intents: data.intents\n          }\n        }));\n      } catch (_) {\n        // noop: 部分环境下 window 不可用\n      }\n    }\n  }\n\n  /**\n   * 处理智能调度响应\n   */\n  async handleDispatchResponse(response) {\n    if (!response.success) {\n      // 处理错误响应\n      const errorMessage = response.error || '抱歉，系统遇到了问题。';\n      this.addAIMessage(errorMessage, MESSAGE_TYPES.ERROR, {\n        apiError: response.error\n      });\n      return;\n    }\n    const {\n      data\n    } = response;\n\n    // 添加AI回复\n    this.addAIMessage(data.response, MESSAGE_TYPES.TEXT, {\n      intents: data.intents,\n      servicesExecuted: data.servicesExecuted,\n      taskCreated: data.taskCreated,\n      scheduleAdjusted: data.scheduleAdjusted,\n      emotionalSupport: data.emotionalSupport,\n      processingTime: response.processingTime\n    });\n\n    // 如果有任务创建，添加任务创建消息\n    if (data.taskCreated) {\n      this.addTaskCreatedMessage(data.taskCreated);\n    }\n\n    // 如果有日程调整，添加日程调整消息\n    if (data.scheduleAdjusted) {\n      this.addScheduleAdjustedMessage(data.scheduleAdjusted);\n    }\n\n    // 通知任务页刷新（如果有任务相关操作）\n    if (data.taskCreated || data.scheduleAdjusted) {\n      try {\n        window.dispatchEvent(new CustomEvent('ai-dispatch-completed', {\n          detail: {\n            taskCreated: data.taskCreated,\n            scheduleAdjusted: data.scheduleAdjusted,\n            intents: data.intents\n          }\n        }));\n      } catch (_) {\n        // noop: 部分环境下 window 不可用\n      }\n    }\n  }\n\n  /**\n   * 添加任务创建成功消息\n   */\n  addTaskCreatedMessage(task) {\n    let message = `✅ 任务已创建：${task.title}`;\n    if (task.scheduledTime) {\n      message += `，安排在 ${task.date} ${task.scheduledTime}`;\n    }\n    this.addAIMessage(message, MESSAGE_TYPES.TASK_CREATED, {\n      task: task\n    });\n  }\n\n  /**\n   * 添加日程调整消息\n   */\n  addScheduleAdjustedMessage(scheduleInfo) {\n    const message = '⏰ 日程已根据你的需求进行调整';\n    this.addAIMessage(message, MESSAGE_TYPES.SCHEDULE_ADJUSTED, {\n      scheduleInfo: scheduleInfo\n    });\n  }\n\n  /**\n   * 检查是否正在处理中\n   */\n  isCurrentlyProcessing() {\n    return this.isProcessing;\n  }\n\n  /**\n   * 获取当前会话ID\n   */\n  getCurrentSessionId() {\n    return this.currentSessionId;\n  }\n\n  /**\n   * 设置会话ID\n   */\n  setSessionId(sessionId) {\n    this.currentSessionId = sessionId;\n    console.log(`🔄 设置会话ID: ${sessionId}`);\n  }\n\n  /**\n   * 创建新会话\n   */\n  createNewSession() {\n    this.currentSessionId = aisiriService.createNewSession();\n    console.log(`🆕 创建新会话: ${this.currentSessionId}`);\n    return this.currentSessionId;\n  }\n\n  /**\n   * 清除所有消息\n   */\n  clearMessages() {\n    this.messages = [];\n    this.currentSessionId = null;\n    this.addWelcomeMessage();\n    console.log('🧹 消息历史已清除');\n  }\n\n  /**\n   * 保存消息到后端\n   */\n  async saveMessageToBackend(content, messageType, metadata = {}) {\n    try {\n      const token = localStorage.getItem('token');\n      if (!token) {\n        console.warn('⚠️ 未找到认证token，无法保存消息到后端');\n        return;\n      }\n      const response = await fetch(getAiApiUrl('/api/ai/conversation/send'), {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`\n        },\n        body: JSON.stringify({\n          content: content,\n          messageType: messageType,\n          sessionId: this.currentSessionId,\n          metadata: metadata\n        })\n      });\n      if (!response.ok) {\n        throw new Error(`HTTP error! status: ${response.status}`);\n      }\n      const result = await response.json();\n      console.log(`💾 消息已保存到后端: ${messageType} - ${content.substring(0, 30)}...`);\n    } catch (error) {\n      console.error('❌ 保存消息到后端失败:', error);\n      // 不抛出错误，避免影响用户体验\n    }\n  }\n\n  /**\n   * 导出消息历史（用于调试）\n   */\n  exportMessages() {\n    return {\n      messages: this.getMessages(),\n      sessionId: this.currentSessionId,\n      timestamp: new Date().toISOString()\n    };\n  }\n}\n\n// 创建单例实例\nconst messageService = new MessageService();\nexport default messageService;","map":{"version":3,"names":["aisiriService","MESSAGE_TYPES","SENDERS","getAiApiUrl","generateMessageId","Date","now","Math","random","toString","substr","createMessage","content","sender","AI","type","TEXT","metadata","id","timestamp","isUser","USER","MessageService","constructor","messages","isProcessing","currentSessionId","historyLoaded","console","log","addWelcomeMessage","welcomeMessage","push","loadHistoryFromBackend","token","localStorage","getItem","warn","response","fetch","method","headers","ok","Error","status","statusText","result","json","success","data","conversations","length","sortedConversations","reverse","forEach","conversation","message","_id","messageType","createdAt","intent","sessionId","aiMetadata","error","getMessages","addUserMessage","startsWith","saveMessageToBackend","addAIMessage","substring","addAIReply","addVoiceMessage","voiceData","VOICE","duration","transcription","ceil","audioUrl","audioFile","addSystemMessage","SYSTEM","processUserInput","userInput","dispatch","handleDispatchResponse","ERROR","processVoiceInput","handleVoiceDispatchResponse","originalVoiceData","errorMessage","apiError","intents","servicesExecuted","taskCreated","scheduleAdjusted","emotionalSupport","processingTime","isVoiceInput","addTaskCreatedMessage","addScheduleAdjustedMessage","window","dispatchEvent","CustomEvent","detail","_","task","title","scheduledTime","date","TASK_CREATED","scheduleInfo","SCHEDULE_ADJUSTED","isCurrentlyProcessing","getCurrentSessionId","setSessionId","createNewSession","clearMessages","body","JSON","stringify","exportMessages","toISOString","messageService"],"sources":["/Users/bytedance/Desktop/backend(2)/timer/src/AIsiri/services/messageService.js"],"sourcesContent":["/**\n * AIsiri 智能调度消息处理服务\n * 处理聊天消息的格式化、存储和状态管理\n */\n\nimport aisiriService from './aiApi.js'\nimport { MESSAGE_TYPES, SENDERS } from '../types/index.js'\nimport { getAiApiUrl } from '../../config/api.js'\n\n/**\n * 生成唯一消息ID\n */\nfunction generateMessageId() {\n  return `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`\n}\n\n/**\n * 创建消息对象\n */\nfunction createMessage(content, sender = SENDERS.AI, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n  return {\n    id: generateMessageId(),\n    content,\n    sender,\n    type,\n    timestamp: new Date(),\n    metadata,\n    isUser: sender === SENDERS.USER\n  }\n}\n\n/**\n * 消息服务类\n */\nclass MessageService {\n  constructor() {\n    this.messages = []\n    this.isProcessing = false\n    this.currentSessionId = null\n    this.historyLoaded = false\n    \n    console.log('💬 AIsiri智能调度消息服务初始化完成')\n  }\n\n  /**\n   * 添加欢迎消息\n   */\n  addWelcomeMessage() {\n    const welcomeMessage = createMessage(\n      '你好！我是你的AI智能助手。我可以帮助你创建任务、安排日程、提供情绪支持，以及调用各种外部工具。请告诉我你需要什么帮助？',\n      SENDERS.AI,\n      MESSAGE_TYPES.TEXT\n    )\n    this.messages.push(welcomeMessage)\n  }\n\n  /**\n   * 从后端加载历史聊天记录\n   */\n  async loadHistoryFromBackend() {\n    if (this.historyLoaded) {\n      console.log('📚 历史记录已加载，跳过重复加载')\n      return\n    }\n\n    try {\n      console.log('📚 开始从后端加载历史聊天记录')\n      \n      const token = localStorage.getItem('token')\n      if (!token) {\n        console.warn('⚠️ 未找到认证token，跳过历史记录加载')\n        this.addWelcomeMessage()\n        return\n      }\n\n      const response = await fetch(getAiApiUrl('/conversation/history?limit=50'), {\n        method: 'GET',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n          'Content-Type': 'application/json'\n        }\n      })\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`)\n      }\n\n      const result = await response.json()\n      \n      if (result.success && result.data.conversations && result.data.conversations.length > 0) {\n        console.log(`📚 成功加载 ${result.data.conversations.length} 条历史记录`)\n        \n        // 清空当前消息列表\n        this.messages = []\n        \n        // 转换后端数据格式为前端消息格式\n        // 后端返回的是降序排列（最新在前），需要反转为升序（最旧在前）\n        const sortedConversations = result.data.conversations.reverse()\n        \n        sortedConversations.forEach(conversation => {\n          const message = {\n            id: conversation._id,\n            content: conversation.content,\n            sender: conversation.messageType === 'user' ? SENDERS.USER : SENDERS.AI,\n            type: MESSAGE_TYPES.TEXT,\n            timestamp: new Date(conversation.createdAt),\n            metadata: {\n              intent: conversation.intent,\n              sessionId: conversation.sessionId,\n              aiMetadata: conversation.aiMetadata\n            },\n            isUser: conversation.messageType === 'user'\n          }\n          this.messages.push(message)\n        })\n        \n        this.historyLoaded = true\n        console.log('✅ 历史聊天记录加载完成')\n      } else {\n        console.log('📚 没有找到历史记录，添加欢迎消息')\n        this.addWelcomeMessage()\n      }\n      \n    } catch (error) {\n      console.error('❌ 加载历史聊天记录失败:', error)\n      // 加载失败时添加欢迎消息\n      if (this.messages.length === 0) {\n        this.addWelcomeMessage()\n      }\n    }\n  }\n\n  /**\n   * 获取所有消息\n   */\n  getMessages() {\n    return [...this.messages]\n  }\n\n  /**\n   * 添加用户消息\n   */\n  addUserMessage(content, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n    // 检查是否是图片消息\n    let messageType = type\n    if (content && content.startsWith('🖼️ 图片：')) {\n      messageType = 'IMAGE' // 使用自定义图片类型\n    }\n    \n    const message = createMessage(content, SENDERS.USER, messageType, metadata)\n    this.messages.push(message)\n    \n    console.log(`📝 用户消息: ${content}`)\n    \n    // 保存用户消息到后端\n    this.saveMessageToBackend(content, 'user', metadata)\n    \n    return message\n  }\n\n  /**\n   * 添加AI消息\n   */\n  addAIMessage(content, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n    const message = createMessage(content, SENDERS.AI, type, metadata)\n    this.messages.push(message)\n    \n    console.log(`🤖 AI回复: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`)\n    \n    // 保存AI消息到后端\n    this.saveMessageToBackend(content, 'ai', metadata)\n    \n    return message\n  }\n\n  /**\n   * 添加AI回复（不触发智能调度）\n   */\n  addAIReply(content, type = MESSAGE_TYPES.TEXT, metadata = {}) {\n    const message = createMessage(content, SENDERS.AI, type, metadata)\n    this.messages.push(message)\n    \n    console.log(`🤖 AI直接回复: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`)\n    return message\n  }\n\n  /**\n   * 添加语音消息\n   */\n  addVoiceMessage(voiceData, isUser = false) {\n    const message = {\n      id: Date.now() + Math.random(),\n      type: MESSAGE_TYPES.VOICE,\n      isUser: isUser,\n      timestamp: new Date(),\n      duration: voiceData.transcription ? Math.ceil(voiceData.transcription.length / 5) : 3, // 根据文字长度估算时长\n      transcription: voiceData.transcription || '',\n      audioUrl: voiceData.audioUrl || '',\n      audioFile: voiceData.audioFile || null\n    }\n    \n    this.messages.push(message)\n    console.log(`🎤 ${isUser ? '用户' : 'AI'}语音消息已添加: ${voiceData.transcription?.substring(0, 50) || '无文字'}...`)\n    \n    return message\n  }\n\n  /**\n   * 添加系统消息\n   */\n  addSystemMessage(content) {\n    const message = createMessage(content, SENDERS.SYSTEM, MESSAGE_TYPES.TEXT)\n    this.messages.push(message)\n    \n    console.log(`⚙️  系统消息: ${content}`)\n    return message\n  }\n\n  /**\n   * 处理用户输入的主要方法 - 使用智能调度系统\n   */\n  async processUserInput(userInput) {\n    if (this.isProcessing) {\n      console.log('⏳ 正在处理中，请稍等...')\n      return\n    }\n\n    try {\n      this.isProcessing = true\n      \n      // 1. 添加用户消息\n      this.addUserMessage(userInput)\n      \n      // 2. 调用AIsiri智能调度\n      console.log('\\n🚀 开始智能调度处理...')\n      const response = await aisiriService.dispatch(userInput, this.currentSessionId)\n      \n      // 3. 处理智能调度响应\n      await this.handleDispatchResponse(response)\n      \n    } catch (error) {\n      console.error('❌ 智能调度处理失败:', error)\n      this.addAIMessage(\n        '抱歉，我遇到了一些技术问题。请稍后再试，或者尝试重新描述你的需求。',\n        MESSAGE_TYPES.ERROR,\n        { error: error.message }\n      )\n    } finally {\n      this.isProcessing = false\n    }\n  }\n\n  /**\n   * 处理用户语音输入 - 返回语音回复\n   */\n  async processVoiceInput(voiceData) {\n    if (this.isProcessing) {\n      console.log('⏳ 正在处理中，请稍等...')\n      return\n    }\n\n    try {\n      this.isProcessing = true\n      \n      // 1. 添加用户语音消息\n      this.addVoiceMessage(voiceData, true) // true表示是用户消息\n      \n      // 2. 调用AIsiri智能调度\n      console.log('\\n🚀 开始智能调度处理语音输入...')\n      const response = await aisiriService.dispatch(voiceData.transcription, this.currentSessionId)\n      \n      // 3. 处理智能调度响应，生成语音回复\n      await this.handleVoiceDispatchResponse(response, voiceData)\n      \n    } catch (error) {\n      console.error('❌ 语音智能调度处理失败:', error)\n      this.addVoiceMessage({\n        transcription: '抱歉，我遇到了一些技术问题。请稍后再试，或者尝试重新描述你的需求。',\n        duration: 3,\n        isUser: false\n      }, false) // false表示是AI消息\n    } finally {\n      this.isProcessing = false\n    }\n  }\n\n  /**\n   * 处理语音智能调度响应 - AI回复保持文字形式\n   */\n  async handleVoiceDispatchResponse(response, originalVoiceData) {\n    if (!response.success) {\n      // 处理错误响应\n      const errorMessage = response.error || '抱歉，系统遇到了问题。'\n      this.addAIMessage(errorMessage, MESSAGE_TYPES.ERROR, { apiError: response.error })\n      return\n    }\n\n    const { data } = response\n    \n    // AI回复保持文字形式，不转换为语音\n    this.addAIMessage(data.response, MESSAGE_TYPES.TEXT, {\n      intents: data.intents,\n      servicesExecuted: data.servicesExecuted,\n      taskCreated: data.taskCreated,\n      scheduleAdjusted: data.scheduleAdjusted,\n      emotionalSupport: data.emotionalSupport,\n      processingTime: response.processingTime,\n      isVoiceInput: true // 标记这是来自语音输入的回复\n    })\n    \n    // 如果有任务创建，添加任务创建消息\n    if (data.taskCreated) {\n      this.addTaskCreatedMessage(data.taskCreated)\n    }\n\n    // 如果有日程调整，添加日程调整消息\n    if (data.scheduleAdjusted) {\n      this.addScheduleAdjustedMessage(data.scheduleAdjusted)\n    }\n\n    // 通知任务页刷新（如果有任务相关操作）\n    if (data.taskCreated || data.scheduleAdjusted) {\n      try {\n        window.dispatchEvent(new CustomEvent('ai-dispatch-completed', {\n          detail: {\n            taskCreated: data.taskCreated,\n            scheduleAdjusted: data.scheduleAdjusted,\n            intents: data.intents\n          }\n        }))\n      } catch (_) {\n        // noop: 部分环境下 window 不可用\n      }\n    }\n  }\n\n  /**\n   * 处理智能调度响应\n   */\n  async handleDispatchResponse(response) {\n    if (!response.success) {\n      // 处理错误响应\n      const errorMessage = response.error || '抱歉，系统遇到了问题。'\n      this.addAIMessage(errorMessage, MESSAGE_TYPES.ERROR, { apiError: response.error })\n      return\n    }\n\n    const { data } = response\n    \n    // 添加AI回复\n    this.addAIMessage(data.response, MESSAGE_TYPES.TEXT, {\n      intents: data.intents,\n      servicesExecuted: data.servicesExecuted,\n      taskCreated: data.taskCreated,\n      scheduleAdjusted: data.scheduleAdjusted,\n      emotionalSupport: data.emotionalSupport,\n      processingTime: response.processingTime\n    })\n\n    // 如果有任务创建，添加任务创建消息\n    if (data.taskCreated) {\n      this.addTaskCreatedMessage(data.taskCreated)\n    }\n\n    // 如果有日程调整，添加日程调整消息\n    if (data.scheduleAdjusted) {\n      this.addScheduleAdjustedMessage(data.scheduleAdjusted)\n    }\n\n    // 通知任务页刷新（如果有任务相关操作）\n    if (data.taskCreated || data.scheduleAdjusted) {\n      try {\n        window.dispatchEvent(new CustomEvent('ai-dispatch-completed', {\n          detail: {\n            taskCreated: data.taskCreated,\n            scheduleAdjusted: data.scheduleAdjusted,\n            intents: data.intents\n          }\n        }))\n      } catch (_) {\n        // noop: 部分环境下 window 不可用\n      }\n    }\n  }\n\n  /**\n   * 添加任务创建成功消息\n   */\n  addTaskCreatedMessage(task) {\n    let message = `✅ 任务已创建：${task.title}`\n    if (task.scheduledTime) {\n      message += `，安排在 ${task.date} ${task.scheduledTime}`\n    }\n    \n    this.addAIMessage(message, MESSAGE_TYPES.TASK_CREATED, {\n      task: task\n    })\n  }\n\n  /**\n   * 添加日程调整消息\n   */\n  addScheduleAdjustedMessage(scheduleInfo) {\n    const message = '⏰ 日程已根据你的需求进行调整'\n    \n    this.addAIMessage(message, MESSAGE_TYPES.SCHEDULE_ADJUSTED, {\n      scheduleInfo: scheduleInfo\n    })\n  }\n\n  /**\n   * 检查是否正在处理中\n   */\n  isCurrentlyProcessing() {\n    return this.isProcessing\n  }\n\n  /**\n   * 获取当前会话ID\n   */\n  getCurrentSessionId() {\n    return this.currentSessionId\n  }\n\n  /**\n   * 设置会话ID\n   */\n  setSessionId(sessionId) {\n    this.currentSessionId = sessionId\n    console.log(`🔄 设置会话ID: ${sessionId}`)\n  }\n\n  /**\n   * 创建新会话\n   */\n  createNewSession() {\n    this.currentSessionId = aisiriService.createNewSession()\n    console.log(`🆕 创建新会话: ${this.currentSessionId}`)\n    return this.currentSessionId\n  }\n\n  /**\n   * 清除所有消息\n   */\n  clearMessages() {\n    this.messages = []\n    this.currentSessionId = null\n    this.addWelcomeMessage()\n    console.log('🧹 消息历史已清除')\n  }\n\n  /**\n   * 保存消息到后端\n   */\n  async saveMessageToBackend(content, messageType, metadata = {}) {\n    try {\n      const token = localStorage.getItem('token')\n      if (!token) {\n        console.warn('⚠️ 未找到认证token，无法保存消息到后端')\n        return\n      }\n\n      const response = await fetch(getAiApiUrl('/api/ai/conversation/send'), {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`\n        },\n        body: JSON.stringify({\n          content: content,\n          messageType: messageType,\n          sessionId: this.currentSessionId,\n          metadata: metadata\n        })\n      })\n\n      if (!response.ok) {\n        throw new Error(`HTTP error! status: ${response.status}`)\n      }\n\n      const result = await response.json()\n      console.log(`💾 消息已保存到后端: ${messageType} - ${content.substring(0, 30)}...`)\n      \n    } catch (error) {\n      console.error('❌ 保存消息到后端失败:', error)\n      // 不抛出错误，避免影响用户体验\n    }\n  }\n\n  /**\n   * 导出消息历史（用于调试）\n   */\n  exportMessages() {\n    return {\n      messages: this.getMessages(),\n      sessionId: this.currentSessionId,\n      timestamp: new Date().toISOString()\n    }\n  }\n}\n\n// 创建单例实例\nconst messageService = new MessageService()\n\nexport default messageService"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}